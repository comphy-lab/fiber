<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
  <!-- Eliminate FOUC (Flash of Unstyled Content) and FOUT (Flash of Incorrect Theme) -->
  <script>
    (function() {
  try {
    // Apply the theme as quickly as possible to avoid flash
    let saved;
    try {
      saved = localStorage.getItem('theme');
    } catch (storageError) {
      // Handle localStorage access errors (private browsing, cookies disabled)
      console.warn('Unable to access localStorage:', storageError);
    }
<a id="" href="#"></a>
    let prefersDark = false;
    try {
      prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    } catch (mediaError) {
      // Handle matchMedia access errors (unsupported browsers)
      console.warn('Unable to check media query:', mediaError);
    }
<a id="" href="#"></a>
    const theme = saved ? saved : (prefersDark ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', theme);
    // Add theme class for CSS targeting
    document.documentElement.classList.add(theme + '-theme');
    // Mark when theme is set for CSS transitions
    document.documentElement.classList.add('theme-set');
  } catch (error) {
    // Fallback for any other unexpected errors
    console.warn('Theme initialization failed:', error);
    // Apply default theme as fallback
    try {
      document.documentElement.setAttribute('data-theme', 'light');
      document.documentElement.classList.add('light-theme');
      document.documentElement.classList.add('theme-set');
    } catch (fallbackError) {
      // Silent catch for extreme cases
      console.error('Critical theme fallback failed:', fallbackError);
    }
  }
})();
  </script>
<a id="" href="#"></a>
<a id="" href="#"></a>
  <!-- No-JS fallback for theme and critical theming styles -->
  <style>
    /* Default light theme variables */
    :root {
      /* Base colors */
      --color-background: #fff;
      --color-text: #333;
      --color-primary: #0066cc;
      --color-secondary: #036;
      --color-accent: #0099ff;
<a id="" href="#"></a>
      /* UI elements */
      --color-header-bg: #f5f5f5;
      --color-footer-bg: #2d2e33;
      --color-border: #e0e0e0;
      --color-input-bg: #f9f9f9;
<a id="" href="#"></a>
      /* Component colors */
      --color-preloader-bg: #ffffff;
      --color-loader: #0066cc;
      --color-card-bg: #ffffff;
      --color-code-bg: #f5f5f5;
    }
<a id="" href="#"></a>
    /* Dark theme variables applied via media query when JS is disabled */
    @media (prefers-color-scheme: dark) {
      :root:not(.theme-set) {
        /* Base colors - dark mode */
        --color-background: #1a1a1a;
        --color-text: #f5f5f5;
        --color-primary: #4d9fff;
        --color-secondary: #88ccff;
        --color-accent: #00bfff;
<a id="" href="#"></a>
        /* UI elements - dark mode */
        --color-header-bg: #121212;
        --color-footer-bg: #121212;
        --color-border: #333;
        --color-input-bg: #2d2d2d;
<a id="" href="#"></a>
        /* Component colors - dark mode */
        --color-preloader-bg: #1a1a1a;
        --color-loader: #4d9fff;
        --color-card-bg: #222;
        --color-code-bg: #2d2d2d;
      }
    }
<a id="" href="#"></a>
    /* When JS sets the theme explicitly via data attribute */
    [data-theme="dark"] {
      /* Base colors - dark mode */
      --color-background: #1a1a1a;
      --color-text: #f5f5f5;
      --color-primary: #4d9fff;
      --color-secondary: #88ccff;
      --color-accent: #00bfff;
<a id="" href="#"></a>
      /* UI elements - dark mode */
      --color-header-bg: #121212;
      --color-footer-bg: #121212;
      --color-border: #333;
      --color-input-bg: #2d2d2d;
<a id="" href="#"></a>
      /* Component colors - dark mode */
      --color-preloader-bg: #1a1a1a;
      --color-loader: #4d9fff;
      --color-card-bg: #222;
      --color-code-bg: #2d2d2d;
    }
<a id="" href="#"></a>
    /* Prevent transition flashes during initial load */
    html:not(.transitions-enabled) * {
      transition: none !important;
    }
<a id="" href="#"></a>
    /* Apply theme to preloader and early elements */
    #preloader {
      background-color: var(--color-preloader-bg);
      color: var(--color-text);
    }
<a id="" href="#"></a>
    #loader {
      border-color: var(--color-loader);
      border-top-color: transparent;
    }
<a id="" href="#"></a>
    /* Noscript warning */
    .noscript-warning {
      background-color: var(--color-primary);
      color: white;
      text-align: center;
      padding: 10px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
<a id="" href="#"></a>
    /* Theme indicator for no-JS */
    .theme-indicator {
      padding: 5px 10px;
      border-radius: 4px;
      background-color: var(--color-input-bg);
      color: var(--color-text);
      text-align: center;
    }
<a id="" href="#"></a>
    /* Hide JS-only elements when no JS */
    .no-js .js-only {
      display: none !important;
    }
<a id="" href="#"></a>
    /* Show no-JS alternatives */
    .js .no-js-only {
      display: none !important;
    }
  </style>
<a id="" href="#"></a>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="base-url" content="..">
  <title>src-local/log-conform-viscoelastic-scalar-3D.h | Viscoelastic3D</title>
<a id="" href="#"></a>
  <!-- Critical CSS for fastest paint -->
  <style>
      .s-intro__title {
          visibility: visible;
          font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }
      .s-header {
          visibility: visible;
      }
<a id="" href="#"></a>
      /* Ensure theme toggle properly styled immediately */
      .theme-toggle {
          background-color: var(--color-background);
          color: var(--color-text);
      }
<a id="" href="#"></a>
      /* Control SVG visibility based on theme */
      [data-theme="dark"] .theme-toggle-icon.sun,
      :root:not([data-theme="dark"]) .theme-toggle-icon.moon {
          display: block;
      }
<a id="" href="#"></a>
      [data-theme="dark"] .theme-toggle-icon.moon,
      :root:not([data-theme="dark"]) .theme-toggle-icon.sun {
          display: none;
      }
  </style>
<a id="" href="#"></a>
  <!-- Critical Meta Tags -->
  <meta name="description" content="Viscoelastic fluids exhibit both viscous and elastic behaviour when subjected to deformation. Therefore these materials are governed by the Navier--Stokes eq...">
  <meta name="author" content="CoMPhy Lab">
  <meta name="robots" content="index, follow">
  <meta name="keywords" content="bcg.h, conform, converts, debug_eigenvalues, eigen_decomposition.h, performs, scalar, struct, viscoelastic">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-title" content="CoMPhy Lab">
<a id="" href="#"></a>
  <!-- Preload critical resources -->
  <link rel="preload" href="../assets/js/main.js" as="script">
  <link rel="preload" href="../assets/css/fontello/css/fontello.css" as="style">
  <link rel="preload" href="../assets/css/academicons-1.7.0/css/academicons.min.css" as="style">
<a id="" href="#"></a>
  <!-- Base stylesheets -->
  <link rel="stylesheet" href="../assets/css/styles.css">
  <link rel="stylesheet" href="../assets/css/custom_styles.css">
  <link rel="stylesheet" href="../assets/css/command-palette.css">
  <link rel="stylesheet" href="../assets/css/fontello/css/fontello.css">
  <link rel="stylesheet" href="../assets/css/academicons-1.7.0/css/academicons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
<a id="" href="#"></a>
  <!-- Font optimization -->
  <style>
      @font-face {
          font-display: swap;
          font-family: 'System Font';
          src: local('system-ui');
      }
  </style>
<a id="" href="#"></a>
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="96x96" href="../assets/favicon/favicon-96x96.png">
  <link rel="icon" type="image/svg+xml" href="../assets/favicon/favicon.svg">
  <link rel="shortcut icon" href="../assets/favicon/favicon.ico">
  <link rel="manifest" href="../assets/favicon/site.webmanifest">
<a id="" href="#"></a>
  <!-- Scripts with proper loading attributes -->
  <script src="../assets/js/jquery.min.js"></script>
  <script src="../assets/js/jquery-ui.packed.js"></script>
  <script src="../assets/js/plots.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
  <script defer src="../assets/js/command-palette.js"></script>
  <script defer src="../assets/js/command-data.js"></script>
  <script defer src="../assets/js/main.js"></script>
  <script defer src="../assets/js/theme-toggle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script"></script>
<a id="" href="#"></a>
  <!-- Optimize page load performance -->
  <script>
    // Preconnect to critical domains
    const preconnectDomains = [
      'https://cdnjs.cloudflare.com',
      'https://cdn.jsdelivr.net'
    ];
<a id="" href="#"></a>
    preconnectDomains.forEach(domain => {
      const link = document.createElement('link');
      link.rel = 'preconnect';
      link.href = domain;
      link.crossOrigin = 'anonymous';
      document.head.appendChild(link);
<a id="" href="#"></a>
      // Also add DNS prefetch as fallback
      const dnsLink = document.createElement('link');
      dnsLink.rel = 'dns-prefetch';
      dnsLink.href = domain;
      document.head.appendChild(dnsLink);
    });
<a id="" href="#"></a>
    // Detect when document is fully loaded to remove preloader
    window.addEventListener('load', function() {
      const preloader = document.getElementById('preloader');
      if (preloader) {
        preloader.style.opacity = '0';
        setTimeout(() => {
          preloader.style.display = 'none';
        }, 300); // Match transition duration
      }
    });
  </script>
<a id="" href="#"></a>
  <script>
      // Load Font Awesome with proper environment detection and fallbacks
      function loadStylesheet(href) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        link.crossOrigin = 'anonymous';
        link.onerror = (e) => {
          console.error(`Failed to load stylesheet: `, e);
          console.log('Trying alternative Font Awesome source...');
        };
        document.head.appendChild(link);
        return link;
      }
<a id="" href="#"></a>
      // Check if we're on localhost
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        // Use hardcoded version numbers for reliable loading
<a id="" href="#"></a>
        // Load Font Awesome using multiple CDNs to maximize reliability for local development
        loadStylesheet('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css');
        // Backup CDN if the first one fails
        loadStylesheet('https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css');
        // Final local fallback - ensures it will work on any localhost environment
        loadStylesheet('https://use.fontawesome.com/releases/v6.7.2/css/all.css');
      } else {
        // Use Kit for production with defer
        var script = document.createElement('script');
        script.src = 'https://kit.fontawesome.com/b1cfd9ca75.js';
        script.crossOrigin = 'anonymous';
        script.defer = true;
        document.head.appendChild(script);
      }
    </script>
<a id="" href="#"></a>
  <script>
      // Mark page as JS-enabled and manage transitions
      document.documentElement.classList.remove('no-js');
      document.documentElement.classList.add('js');
<a id="" href="#"></a>
      // Allow CSS transitions after initial load to prevent transition flashes
      window.addEventListener('DOMContentLoaded', () => {
          setTimeout(() => {
              document.documentElement.classList.add('transitions-enabled');
          }, 100); // Short delay to ensure DOM is ready
      });
  </script>
</head>
<body id="top">
<script>window.repoName = "Viscoelastic3D";</script>

<a id="" href="#"></a>
    <!-- Preloader with theme variables applied -->
    <div id="preloader">
        <div id="loader"></div>
    </div>
<a id="" href="#"></a>
    <noscript>
        <div class="noscript-warning">
            <p>This site works best with JavaScript enabled. Some features may be limited.</p>
        </div>
    </noscript>
<a id="" href="#"></a>
    <div id="page" class="s-pagewrap">
        <header class="s-header">
            <div class="s-header__logo">
                <a class="logo" href="/">
                    <img src="../assets/logos/CoMPhy-Lab-no-name.png" alt="CoMPhy Lab">
                </a>
                <a class="documentation-button" href="/Viscoelastic3D">
                    <i class="fa-solid fa-book-open"></i>
                    <span>Viscoelastic3D</span>
                </a>
            </div>
            <a class="s-header__menu-toggle" href="#0">
                <span class="s-header__menu-text">Menu</span>
                <span class="s-header__menu-icon"></span>
            </a>
            <nav class="s-header__nav">
                <a href="#0" class="s-header__nav-close-btn"><span>Close</span></a>
                <ul class="s-header__nav-list">
                    <li style="background: none;">
                        <!-- JS theme toggle -->
                        <div class="theme-toggle js-only" id="theme-toggle" aria-label="Toggle dark/light theme">
                            <svg class="theme-toggle-icon moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                            </svg>
                            <svg class="theme-toggle-icon sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="5"></circle>
                                <line x1="12" y1="1" x2="12" y2="3"></line>
                                <line x1="12" y1="21" x2="12" y2="23"></line>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                <line x1="1" y1="12" x2="3" y2="12"></line>
                                <line x1="21" y1="12" x2="23" y2="12"></line>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                            </svg>
                        </div>
                    </li>
                    <li style="background: none;"><a href="https://scholar.google.com/citations?user=tHb_qZoAAAAJ&hl=en" style="background: none; padding: 0;" aria-label="Google Scholar Profile"><i class="ai ai-google-scholar" style="font-size: 1.75em;"></i></a></li>
                    <li style="background: none;"><a href="https://github.com/comphy-lab" style="background: none; padding: 0;" aria-label="GitHub Organization"><i class="fa-brands fa-github" style="font-size: 1.75em"></i></a></li>
                    <li><a href="https://comphy-lab.org/#about" class="smoothscroll">About</a></li>
                    <li><a href="https://comphy-lab.org/team/">Team</a></li>
                    <li><a href="https://comphy-lab.org/research">Research</a></li>
                    <li><a href="https://comphy-lab.org/teaching">Teaching</a></li>
                    <li><a href="https://comphy-lab.org/join">Join Us</a></li>
                    <li><a href="https://blogs.comphy-lab.org/">Blog</a></li>
                    <li style="background: none;"><a href="https://bsky.app/profile/comphy-lab.org" style="background: none; padding: 0;" aria-label="Bluesky Profile"><i class="fa-brands fa-bluesky" style="font-size: 1.75em; color: #0085ff;"></i></a></li>
                    <!-- Command Palette Button (Styled like search) -->
                    <li class="command-palette-button">
                        <div class="command-wrapper">
                            <button class="command-k-style-btn" id="command-palette-btn" aria-label="Open command palette">
                                <span class="default-theme-text">ctrl K</span>
                                <span class="mac-theme-text">⌘ K</span>
                                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                            </button>
                        </div>
                    </li>
                </ul>
            </nav>
        </header>
<a id="" href="#"></a>
        <!-- Main content -->
        <main class="content">
<a id="" href="#"></a>
            <div class="page-content">
<a id="" href="#"></a>
                                <h1 class="page-title">src-local/log-conform-viscoelastic-scalar-3D.h</h1>
<a id="" href="#"></a>
<a id="" href="#"></a>
                                <div class="raw-file-button-container">
                    <a href="https://github.com/comphy-lab/Viscoelastic3D/raw/main/src-local/log-conform-viscoelastic-scalar-3D.h" class="raw-file-button" target="_blank">
                        <i class="fa-brands fa-github"></i> See raw file
                    </a>
                </div>
<a id="" href="#"></a>
                <h1
                id="log-conformation-method-for-3d-viscoelastic-fluids">Log-Conformation
                Method for 3D Viscoelastic Fluids</h1>
                <h2 id="overview">Overview</h2>
                <ul>
                <li><strong>Title</strong>:
                log-conform-viscoelastic-3D.h</li>
                <li><strong>Version</strong>: 2.6</li>
                <li><strong>Description</strong>: Implementation of the
                log-conformation method for viscoelastic fluids in
                3D</li>
                </ul>
                <h3 id="key-features">Key Features</h3>
                <ol type="1">
                <li>Conformation tensor A exists across the domain and
                relaxes according to λ</li>
                <li>Stress acts according to elastic modulus G</li>
                <li>3D implementation extending
                log-conform-viscoelastic-scalar-2D.h</li>
                <li>Eigenvalue clamping for numerical stability</li>
                </ol>
                <h3 id="author-information">Author Information</h3>
                <ul>
                <li><strong>Name</strong>: Vatsal Sanjay</li>
                <li><strong>Email</strong>: vatsalsanjay@gmail.com</li>
                <li><strong>Institution</strong>: Physics of Fluids</li>
                <li><strong>Last Updated</strong>: Mar 16, 2025</li>
                </ul>
                <h3 id="dependencies">Dependencies</h3>
                <ul>
                <li>bcg.h: Bell-Collela-Glaz scheme for advection</li>
                <li>eigen_decomposition.h: For 3D eigenvalue
                computation</li>
                <li>navier-stokes/centered.h: For base flow solver</li>
                </ul>
                <h3 id="references">References</h3>
                <ul>
                <li>Fattal &amp; Kupferman (2004, 2005): Original
                log-conformation method</li>
                <li>Comminal et al. (2015): Constitutive model
                functions</li>
                <li>Hao &amp; Pan (2007): Split scheme
                implementation</li>
                </ul>
                <h2 id="version-history">Version History</h2>
                <h3 id="v1.0-oct-19-2024">v1.0 (Oct 19, 2024)</h3>
                <ul>
                <li>Initial 3D implementation</li>
                <li>Scalar implementation approach</li>
                </ul>
                <h3 id="v1.1-oct-20-2024">v1.1 (Oct 20, 2024)</h3>
                <ul>
                <li>Added negative eigenvalue detection</li>
                <li>Added error reporting system</li>
                </ul>
                <h3 id="v2.0-oct-29-2024">v2.0 (Oct 29, 2024)</h3>
                <ul>
                <li>Major matrix algebra corrections for 3D</li>
                <li>Optimized tensor calculations</li>
                <li>Improved code structure and documentation</li>
                </ul>
                <h3 id="v2.1-oct-29-2024">v2.1 (Oct 29, 2024)</h3>
                <ul>
                <li>Added initialization functions for tensor
                structures</li>
                </ul>
                <h3 id="v2.2-nov-3-2024">v2.2 (Nov 3, 2024)</h3>
                <ul>
                <li>Refactored tensor operations</li>
                <li>Improved code maintainability</li>
                <li>Enhanced tensor manipulation consistency</li>
                </ul>
                <h3 id="v2.3-nov-14-2024">v2.3 (Nov 14, 2024)</h3>
                <ul>
                <li>Added infinite Deborah number support</li>
                </ul>
                <h3 id="v2.5-nov-23-2024">v2.5 (Nov 23, 2024)</h3>
                <ul>
                <li>Documentation improvements</li>
                <li>Added mathematical explanations</li>
                </ul>
                <h3 id="v2.6-mar-16-2025">v2.6 (Mar 16, 2025)</h3>
                <ul>
                <li>Implemented eigenvalue clamping system</li>
                <li>Added minimum eigenvalue threshold (EIGENVALUE_MIN =
                1e-8)</li>
                <li>Improved numerical stability handling</li>
                <li>Added diagnostic capabilities</li>
                <li>Fixed 3D velocity gradient calculation</li>
                </ul>
                <h2 id="implementation-notes">Implementation Notes</h2>
                <ol type="1">
                <li>The code extends the standard Basilisk
                log-conformation implementation</li>
                <li>Uses G-λ formulation for better physical
                interpretation</li>
                <li>Fixes surface tension coupling with polymeric
                stress</li>
                <li>Includes both 2D and 3D implementations</li>
                <li>Uses atomic operations for thread-safe
                diagnostics</li>
                </ol>
                <h2 id="future-work">Future Work</h2>
                <h3 id="axisymmetric-compatibility">Axisymmetric
                Compatibility</h3>
                <ul>
                <li>Currently not implemented</li>
                <li>Use log-conform-viscoelastic-scalar-2D.h for axi
                cases</li>
                <li>Or use log-conform-viscoelastic.h for better
                efficiency</li>
                </ul>
                <h3 id="metric-terms-improvements">Metric Terms
                Improvements</h3>
                <ul class="task-list">
                <li><label><input type="checkbox" />Enforce tensor
                compatibility using foreach_dimension</label></li>
                <li><label><input type="checkbox" />Complete metric
                terms (cm, fm) implementation</label></li>
                </ul>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><span class="pp">#if AXI</span></span>
<span id="cb1-2"><span class="pp">#error &quot;axi compatibility is not there. To keep the code easy to read, we will not implement axi compatibility just yet.&quot;</span></span>
<span id="cb1-3"><span class="pp">#endif</span></span></code></pre></div></div>
                <h1
                id="the-log-conformation-method-for-some-viscoelastic-constitutive-models">The
                log-conformation method for some viscoelastic
                constitutive models</h1>
                <h2 id="introduction">Introduction</h2>
                <p>Viscoelastic fluids exhibit both viscous and elastic
                behaviour when subjected to deformation. Therefore these
                materials are governed by the Navier–Stokes equations
                enriched with an extra <em>elastic</em> stress <span
                class="math inline">\(Tij\)</span> <span
                class="math display">\[
                \rho\left[\partial_t\mathbf{u}+\nabla\cdot(\mathbf{u}\otimes\mathbf{u})\right]
                =
                - \nabla p + \nabla\cdot(2\mu_s\mathbf{D}) +
                \nabla\cdot\mathbf{T}
                + \rho\mathbf{a}
                \]</span> where <span
                class="math inline">\(\mathbf{D}=[\nabla\mathbf{u} +
                (\nabla\mathbf{u})^T]/2\)</span> is the deformation
                tensor and <span class="math inline">\(\mu_s\)</span> is
                the solvent viscosity of the viscoelastic fluid.</p>
                <p>The <em>polymeric</em> stress <span
                class="math inline">\(\mathbf{T}\)</span> represents
                memory effects due to the polymers. Several constitutive
                rheological models are available in the literature where
                the polymeric stress <span
                class="math inline">\(\mathbf{T}\)</span> is typically a
                function <span
                class="math inline">\(\mathbf{f_s}(\cdot)\)</span> of
                the conformation tensor <span
                class="math inline">\(\mathbf{A}\)</span> such as <span
                class="math display">\[
                \mathbf{T} = G_p \mathbf{f_s}(\mathbf{A})
                \]</span> where <span class="math inline">\(G_p\)</span>
                is the elastic modulus and <span
                class="math inline">\(\mathbf{f_s}(\cdot)\)</span> is
                the relaxation function.</p>
                <p>The conformation tensor <span
                class="math inline">\(\mathbf{A}\)</span> is related to
                the deformation of the polymer chains. <span
                class="math inline">\(\mathbf{A}\)</span> is governed by
                the equation <span class="math display">\[
                D_t \mathbf{A} - \mathbf{A} \cdot \nabla \mathbf{u} -
                \nabla
                \mathbf{u}^{T} \cdot \mathbf{A} =
                -\frac{\mathbf{f_r}(\mathbf{A})}{\lambda}
                \]</span> where <span class="math inline">\(D_t\)</span>
                denotes the material derivative and <span
                class="math inline">\(\mathbf{f_r}(\cdot)\)</span> is
                the relaxation function. Here, <span
                class="math inline">\(\lambda\)</span> is the relaxation
                time.</p>
                <p>In the case of an Oldroyd-B viscoelastic fluid, <span
                class="math inline">\(\mathbf{f}_s
                (\mathbf{A}) = \mathbf{f}_r (\mathbf{A}) = \mathbf{A}
                -\mathbf{I}\)</span>, and the above equations can be
                combined to avoid the use of <span
                class="math inline">\(\mathbf{A}\)</span> <span
                class="math display">\[
                \mathbf{T} + \lambda (D_t \mathbf{T} -
                \mathbf{T} \cdot \nabla \mathbf{u} -
                \nabla \mathbf{u}^{T} \cdot \mathbf{T})  = 2 G_p\lambda
                \mathbf{D}
                \]</span></p>
                <p><a href="#comminal2015">Comminal et al. (2015)</a>
                gathered the functions <span
                class="math inline">\(\mathbf{f}_s (\mathbf{A})\)</span>
                and <span class="math inline">\(\mathbf{f}_r
                (\mathbf{A})\)</span> for different constitutive
                models.</p>
                <h2 id="parameters">Parameters</h2>
                <p>The primary parameters are the relaxation time <span
                class="math inline">\(\lambda\)</span> and the elastic
                modulus <span class="math inline">\(G_p\)</span>. The
                solvent viscosity <span
                class="math inline">\(\mu_s\)</span> is defined in the
                <a href="navier-stokes/centered.h">Navier-Stokes
                solver</a>.</p>
                <p>Gp and lambda are defined in <a
                href="two-phaseVE.h">two-phaseVE.h</a>.</p>
                <h2 id="the-log-conformation-approach">The log
                conformation approach</h2>
                <p>The numerical resolution of viscoelastic fluid
                problems often faces the <a
                href="http://www.ma.huji.ac.il/~razk/iWeb/My_Site/Research_files/Visco1.pdf">High-Weissenberg
                Number Problem</a>. This is a numerical instability
                appearing when strongly elastic flows create regions of
                high stress and fine features. This instability poses
                practical limits to the values of the relaxation time of
                the viscoelastic fluid, <span
                class="math inline">\(\lambda\)</span>. <a
                href="#fattal2004">Fattal &amp; Kupferman (2004,
                2005)</a> identified the exponential nature of the
                solution as the origin of the instability. They proposed
                to use the logarithm of the conformation tensor <span
                class="math inline">\(\Psi = \log \, \mathbf{A}\)</span>
                rather than the viscoelastic stress tensor to circumvent
                the instability.</p>
                <p>The constitutive equation for the log of the
                conformation tensor is <span class="math display">\[
                D_t \Psi = (\Omega \cdot \Psi -\Psi \cdot \Omega) + 2
                \mathbf{B} +
                \frac{e^{-\Psi} \mathbf{f}_r (e^{\Psi})}{\lambda}
                \]</span> where <span
                class="math inline">\(\Omega\)</span> and <span
                class="math inline">\(\mathbf{B}\)</span> are tensors
                that result from the decomposition of the transpose of
                the tensor gradient of the velocity <span
                class="math display">\[
                (\nabla \mathbf{u})^T = \Omega + \mathbf{B} + N
                \mathbf{A}^{-1}
                \]</span></p>
                <p>The antisymmetric tensor <span
                class="math inline">\(\Omega\)</span> requires only the
                memory of a scalar in 2D since, <span
                class="math display">\[
                \Omega = \left(
                \begin{array}{cc}
                0 &amp; \Omega_{12} \\
                -\Omega_{12} &amp; 0
                \end{array}
                \right)
                \]</span></p>
                <p>For 3D, <span class="math inline">\(\Omega\)</span>
                is a skew-symmetric tensor given by</p>
                <p><span class="math display">\[
                \Omega = \left(
                \begin{array}{ccc}
                0 &amp; \Omega_{12} &amp; \Omega_{13} \\
                -\Omega_{12} &amp; 0 &amp; \Omega_{23} \\
                -\Omega_{13} &amp; -\Omega_{23} &amp; 0
                \end{array}
                \right)
                \]</span></p>
                <p>The log-conformation tensor, <span
                class="math inline">\(\Psi\)</span>, is related to the
                polymeric stress tensor <span
                class="math inline">\(\mathbf{T}\)</span>, by the strain
                function <span class="math inline">\(\mathbf{f}_s
                (\mathbf{A})\)</span> <span class="math display">\[
                \Psi = \log \, \mathbf{A} \quad \mathrm{and} \quad
                \mathbf{T} =
                \frac{G_p}{\lambda} \mathbf{f}_s (\mathbf{A})
                \]</span> where <span class="math inline">\(Tr\)</span>
                denotes the trace of the tensor and <span
                class="math inline">\(L\)</span> is an additional
                property of the viscoelastic fluid.</p>
                <p>We will use the Bell–Collela–Glaz scheme to advect
                the log-conformation tensor <span
                class="math inline">\(\Psi\)</span>.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><span class="co">/*</span></span>
<span id="cb2-2"><span class="al">TODO</span><span class="co">:</span></span>
<span id="cb2-3"><span class="co">- Perhaps, instead of the Bell--Collela--Glaz scheme, we can use the conservative form of the advection equation and transport the log-conformation tensor with the VoF color function, similar to [http://basilisk.fr/src/navier-stokes/conserving.h](http://basilisk.fr/src/navier-stokes/conserving.h)</span></span>
<span id="cb2-4"><span class="co">*/</span></span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="pp">#define EIGENVALUE_MIN </span><span class="fl">1e-8</span><span class="pp"></span><span class="dv">220</span><span class="pp"></span></span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="pp">#ifdef DEBUG_EIGENVALUES</span></span>
<span id="cb2-9"><span class="dt">static</span> <span class="dt">int</span> eigenvalue_corrections <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-10"><span class="pp">#endif</span></span>
<span id="cb2-11"></span>
<span id="cb2-12"><span class="pp">#include </span><a href="http://basilisk.fr/src/bcg.h" title="Link to Basilisk source for bcg.h"><span class="im">"bcg.h"</span></a></span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="op">(</span><span class="dt">const</span><span class="op">)</span> scalar Gp <span class="op">=</span> unity<span class="op">;</span> <span class="co">// elastic modulus</span></span>
<span id="cb2-15"><span class="op">(</span><span class="dt">const</span><span class="op">)</span> scalar lambda <span class="op">=</span> unity<span class="op">;</span> <span class="co">// relaxation time</span></span>
<span id="cb2-16"></span>
<span id="cb2-17"><span class="co">/*</span></span>
<span id="cb2-18"><span class="co">conformation tensor */</span></span>
<span id="cb2-19"><span class="co">// diagonal elements</span></span>
<span id="cb2-20">scalar A11<span class="op">[],</span> A22<span class="op">[],</span> A33<span class="op">[];</span></span>
<span id="cb2-21"><span class="co">// off-diagonal elements</span></span>
<span id="cb2-22">scalar A12<span class="op">[],</span> A13<span class="op">[],</span> A23<span class="op">[];</span></span>
<span id="cb2-23"><span class="co">/*</span></span>
<span id="cb2-24"><span class="co">stress tensor */</span></span>
<span id="cb2-25"><span class="co">// diagonal elements</span></span>
<span id="cb2-26">scalar T11<span class="op">[],</span> T22<span class="op">[],</span> T33<span class="op">[];</span></span>
<span id="cb2-27"><span class="co">// off-diagonal elements</span></span>
<span id="cb2-28">scalar T12<span class="op">[],</span> T13<span class="op">[],</span> T23<span class="op">[];</span></span>
<span id="cb2-29"></span>
<span id="cb2-30">event defaults <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-31">  <span class="cf">if</span> <span class="op">(</span>is_constant <span class="op">(</span>a<span class="op">.</span>x<span class="op">))</span></span>
<span id="cb2-32">    a <span class="op">=</span> new face vector<span class="op">;</span></span>
<span id="cb2-33"></span>
<span id="cb2-34">  <span class="co">/*</span></span>
<span id="cb2-35"><span class="co">  initialize A and T</span></span>
<span id="cb2-36"><span class="co">  */</span></span>
<span id="cb2-37">  <span class="cf">for</span> <span class="op">(</span>scalar s in <span class="op">{</span>A11<span class="op">,</span> A22<span class="op">,</span> A33<span class="op">})</span> <span class="op">{</span></span>
<span id="cb2-38">    foreach <span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-39">      s<span class="op">[]</span> <span class="op">=</span> <span class="fl">1.</span><span class="op">;</span></span>
<span id="cb2-40">    <span class="op">}</span></span>
<span id="cb2-41">  <span class="op">}</span></span>
<span id="cb2-42">  <span class="cf">for</span> <span class="op">(</span>scalar s in <span class="op">{</span>T11<span class="op">,</span> T12<span class="op">,</span> T13<span class="op">,</span> T22<span class="op">,</span> T23<span class="op">,</span> T33<span class="op">,</span> A12<span class="op">,</span> A13<span class="op">,</span> A23<span class="op">})</span> <span class="op">{</span></span>
<span id="cb2-43">    foreach<span class="op">(){</span></span>
<span id="cb2-44">      s<span class="op">[]</span> <span class="op">=</span> <span class="fl">0.</span><span class="op">;</span></span>
<span id="cb2-45">    <span class="op">}</span></span>
<span id="cb2-46">  <span class="op">}</span></span>
<span id="cb2-47"></span>
<span id="cb2-48">  <span class="cf">for</span> <span class="op">(</span>scalar s in <span class="op">{</span>A11<span class="op">,</span> A22<span class="op">,</span> A33<span class="op">,</span> T11<span class="op">,</span> T22<span class="op">,</span> T33<span class="op">,</span> A12<span class="op">,</span> A13<span class="op">,</span> A23<span class="op">,</span> T12<span class="op">,</span> T13<span class="op">,</span> T23<span class="op">})</span> <span class="op">{</span></span>
<span id="cb2-49">    <span class="cf">if</span> <span class="op">(</span>s<span class="op">.</span>boundary<span class="op">[</span>left<span class="op">]</span> <span class="op">!=</span> periodic_bc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-50">      s<span class="op">[</span>left<span class="op">]</span> <span class="op">=</span> neumann<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb2-51">        s<span class="op">[</span>right<span class="op">]</span> <span class="op">=</span> neumann<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb2-52">    <span class="op">}</span></span>
<span id="cb2-53">    <span class="cf">if</span> <span class="op">(</span>s<span class="op">.</span>boundary<span class="op">[</span>top<span class="op">]</span> <span class="op">!=</span> periodic_bc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-54">      s<span class="op">[</span>top<span class="op">]</span> <span class="op">=</span> neumann<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb2-55">        s<span class="op">[</span>bottom<span class="op">]</span> <span class="op">=</span> neumann<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb2-56">    <span class="op">}</span></span>
<span id="cb2-57"><span class="pp">#if dimension ==</span></span>
<span id="cb2-58">    <span class="cf">if</span> <span class="op">(</span>s<span class="op">.</span>boundary<span class="op">[</span>front<span class="op">]</span> <span class="op">!=</span> periodic_bc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-59">      s<span class="op">[</span>front<span class="op">]</span> <span class="op">=</span> neumann<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb2-60">        s<span class="op">[</span>back<span class="op">]</span> <span class="op">=</span> neumann<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb2-61">    <span class="op">}</span></span>
<span id="cb2-62"><span class="pp">#endif</span></span>
<span id="cb2-63">  <span class="op">}</span></span>
<span id="cb2-64"><span class="op">}</span></span></code></pre></div></div>
                <h2 id="useful-functions-in-2d">Useful functions in
                2D</h2>
                <p>The first step is to implement a routine to calculate
                the eigenvalues and eigenvectors of the conformation
                tensor <span
                class="math inline">\(\mathbf{A}\)</span>.</p>
                <p>These structs ressemble Basilisk vectors and tensors
                but are just arrays not related to the grid.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><span class="pp">#if dimension ==</span></span>
<span id="cb3-2"><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span> <span class="dt">double</span> x<span class="op">,</span> y<span class="op">;}</span>   pseudo_v<span class="op">;</span></span>
<span id="cb3-3"><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span> pseudo_v x<span class="op">,</span> y<span class="op">;}</span> pseudo_t<span class="op">;</span></span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co">// Function to initialize pseudo_v</span></span>
<span id="cb3-6"><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> init_pseudo_v<span class="op">(</span>pseudo_v <span class="op">*</span>v<span class="op">,</span> <span class="dt">double</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-7">    v<span class="op">-&gt;</span>x <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb3-8">    v<span class="op">-&gt;</span>y <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb3-9"><span class="op">}</span></span>
<span id="cb3-10"></span>
<span id="cb3-11"><span class="co">// Function to initialize pseudo_t</span></span>
<span id="cb3-12"><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> init_pseudo_t<span class="op">(</span>pseudo_t <span class="op">*</span>t<span class="op">,</span> <span class="dt">double</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-13">    init_pseudo_v<span class="op">(&amp;</span>t<span class="op">-&gt;</span>x<span class="op">,</span> value<span class="op">);</span></span>
<span id="cb3-14">    init_pseudo_v<span class="op">(&amp;</span>t<span class="op">-&gt;</span>y<span class="op">,</span> value<span class="op">);</span></span>
<span id="cb3-15"><span class="op">}</span></span>
<span id="cb3-16"></span>
<span id="cb3-17"><span class="dt">static</span> <span class="dt">void</span> diagonalization_2D <span class="op">(</span>pseudo_v <span class="op">*</span> Lambda<span class="op">,</span> pseudo_t <span class="op">*</span> R<span class="op">,</span> pseudo_t <span class="op">*</span> A<span class="op">)</span></span>
<span id="cb3-18"><span class="op">{</span></span></code></pre></div></div>
                <p>The eigenvalues are saved in vector <span
                class="math inline">\(\Lambda\)</span> computed from the
                trace and the determinant of the symmetric conformation
                tensor <span
                class="math inline">\(\mathbf{A}\)</span>.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb4-1">  <span class="cf">if</span> <span class="op">(</span>sq<span class="op">(</span>A<span class="op">-&gt;</span>x<span class="op">.</span>y<span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1e-15</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-2">    R<span class="op">-&gt;</span>x<span class="op">.</span>x <span class="op">=</span> R<span class="op">-&gt;</span>y<span class="op">.</span>y <span class="op">=</span> <span class="fl">1.</span><span class="op">;</span></span>
<span id="cb4-3">    R<span class="op">-&gt;</span>y<span class="op">.</span>x <span class="op">=</span> R<span class="op">-&gt;</span>x<span class="op">.</span>y <span class="op">=</span> <span class="fl">0.</span><span class="op">;</span></span>
<span id="cb4-4">    Lambda<span class="op">-&gt;</span>x <span class="op">=</span> A<span class="op">-&gt;</span>x<span class="op">.</span>x<span class="op">;</span> Lambda<span class="op">-&gt;</span>y <span class="op">=</span> A<span class="op">-&gt;</span>y<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb4-5">    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb4-6">  <span class="op">}</span></span>
<span id="cb4-7"></span>
<span id="cb4-8">  <span class="dt">double</span> T <span class="op">=</span> A<span class="op">-&gt;</span>x<span class="op">.</span>x <span class="op">+</span> A<span class="op">-&gt;</span>y<span class="op">.</span>y<span class="op">;</span> <span class="co">// Trace of the tensor</span></span>
<span id="cb4-9">  <span class="dt">double</span> D <span class="op">=</span> A<span class="op">-&gt;</span>x<span class="op">.</span>x<span class="op">*</span>A<span class="op">-&gt;</span>y<span class="op">.</span>y <span class="op">-</span> sq<span class="op">(</span>A<span class="op">-&gt;</span>x<span class="op">.</span>y<span class="op">);</span> <span class="co">// Determinant</span></span></code></pre></div></div>
                <p>The eigenvectors, <span
                class="math inline">\(\mathbf{v}_i\)</span> are saved by
                columns in tensor <span class="math inline">\(\mathbf{R}
                = (\mathbf{v}_1|\mathbf{v}_2)\)</span>.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb5-1">  R<span class="op">-&gt;</span>x<span class="op">.</span>x <span class="op">=</span> R<span class="op">-&gt;</span>x<span class="op">.</span>y <span class="op">=</span> A<span class="op">-&gt;</span>x<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb5-2">  R<span class="op">-&gt;</span>y<span class="op">.</span>x <span class="op">=</span> R<span class="op">-&gt;</span>y<span class="op">.</span>y <span class="op">=</span> <span class="op">-</span>A<span class="op">-&gt;</span>x<span class="op">.</span>x<span class="op">;</span></span>
<span id="cb5-3">  <span class="dt">double</span> s <span class="op">=</span> <span class="fl">1.</span><span class="op">;</span></span>
<span id="cb5-4">  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> dimension<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb5-5">    <span class="dt">double</span> <span class="op">*</span> ev <span class="op">=</span> <span class="op">(</span><span class="dt">double</span> <span class="op">*)</span> Lambda<span class="op">;</span></span>
<span id="cb5-6">    ev<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> T<span class="op">/</span><span class="dv">2</span> <span class="op">+</span> s<span class="op">*</span>sqrt<span class="op">(</span>sq<span class="op">(</span>T<span class="op">)/</span><span class="fl">4.</span> <span class="op">-</span> D<span class="op">);</span></span>
<span id="cb5-7">    s <span class="op">*=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb5-8">    <span class="dt">double</span> <span class="op">*</span> Rx <span class="op">=</span> <span class="op">(</span><span class="dt">double</span> <span class="op">*)</span> <span class="op">&amp;</span>R<span class="op">-&gt;</span>x<span class="op">;</span></span>
<span id="cb5-9">    <span class="dt">double</span> <span class="op">*</span> Ry <span class="op">=</span> <span class="op">(</span><span class="dt">double</span> <span class="op">*)</span> <span class="op">&amp;</span>R<span class="op">-&gt;</span>y<span class="op">;</span></span>
<span id="cb5-10">    Ry<span class="op">[</span>i<span class="op">]</span> <span class="op">+=</span> ev<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb5-11">    <span class="dt">double</span> mod <span class="op">=</span> sqrt<span class="op">(</span>sq<span class="op">(</span>Rx<span class="op">[</span>i<span class="op">])</span> <span class="op">+</span> sq<span class="op">(</span>Ry<span class="op">[</span>i<span class="op">]));</span></span>
<span id="cb5-12">    Rx<span class="op">[</span>i<span class="op">]</span> <span class="op">/=</span> mod<span class="op">;</span></span>
<span id="cb5-13">    Ry<span class="op">[</span>i<span class="op">]</span> <span class="op">/=</span> mod<span class="op">;</span></span>
<span id="cb5-14">  <span class="op">}</span></span>
<span id="cb5-15"><span class="op">}</span></span>
<span id="cb5-16"><span class="pp">#endif</span></span>
<span id="cb5-17"></span>
<span id="cb5-18"><span class="co">/*</span></span>
<span id="cb5-19"><span class="co">Now this is the 3D implementation.</span></span>
<span id="cb5-20"><span class="co">*/</span></span>
<span id="cb5-21"><span class="pp">#if dimension ==</span></span>
<span id="cb5-22"></span>
<span id="cb5-23"><span class="pp">#include </span><a href="../src-local/eigen_decomposition.h.html" title="Link to local documentation for eigen_decomposition.h"><span class="im">"eigen_decomposition.h"</span></a></span>
<span id="cb5-24"></span>
<span id="cb5-25"><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span> <span class="dt">double</span> x<span class="op">,</span> y<span class="op">,</span> z<span class="op">;</span> <span class="op">}</span> pseudo_v3d<span class="op">;</span></span>
<span id="cb5-26"><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span> pseudo_v3d x<span class="op">,</span> y<span class="op">,</span> z<span class="op">;</span> <span class="op">}</span> pseudo_t3d<span class="op">;</span></span>
<span id="cb5-27"></span>
<span id="cb5-28"><span class="co">// Function to initialize pseudo_v3d</span></span>
<span id="cb5-29"><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> init_pseudo_v3d<span class="op">(</span>pseudo_v3d <span class="op">*</span>v<span class="op">,</span> <span class="dt">double</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-30">    v<span class="op">-&gt;</span>x <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb5-31">    v<span class="op">-&gt;</span>y <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb5-32">    v<span class="op">-&gt;</span>z <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb5-33"><span class="op">}</span></span>
<span id="cb5-34"></span>
<span id="cb5-35"><span class="co">// Function to initialize pseudo_t3d</span></span>
<span id="cb5-36"><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> init_pseudo_t3d<span class="op">(</span>pseudo_t3d <span class="op">*</span>t<span class="op">,</span> <span class="dt">double</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-37">    init_pseudo_v3d<span class="op">(&amp;</span>t<span class="op">-&gt;</span>x<span class="op">,</span> value<span class="op">);</span></span>
<span id="cb5-38">    init_pseudo_v3d<span class="op">(&amp;</span>t<span class="op">-&gt;</span>y<span class="op">,</span> value<span class="op">);</span></span>
<span id="cb5-39">    init_pseudo_v3d<span class="op">(&amp;</span>t<span class="op">-&gt;</span>z<span class="op">,</span> value<span class="op">);</span></span>
<span id="cb5-40"><span class="op">}</span></span>
<span id="cb5-41"></span>
<span id="cb5-42"><span class="dt">static</span> <span class="dt">void</span> diagonalization_3D <span class="op">(</span>pseudo_v3d <span class="op">*</span> Lambda<span class="op">,</span> pseudo_t3d <span class="op">*</span> R<span class="op">,</span> pseudo_t3d <span class="op">*</span> A<span class="op">)</span></span>
<span id="cb5-43"><span class="op">{</span></span>
<span id="cb5-44">  <span class="co">// Check if the matrix is already diagonal</span></span>
<span id="cb5-45">  <span class="cf">if</span> <span class="op">(</span>sq<span class="op">(</span>A<span class="op">-&gt;</span>x<span class="op">.</span>y<span class="op">)</span> <span class="op">+</span> sq<span class="op">(</span>A<span class="op">-&gt;</span>x<span class="op">.</span>z<span class="op">)</span> <span class="op">+</span> sq<span class="op">(</span>A<span class="op">-&gt;</span>y<span class="op">.</span>z<span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1e-15</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-46">    R<span class="op">-&gt;</span>x<span class="op">.</span>x <span class="op">=</span> R<span class="op">-&gt;</span>y<span class="op">.</span>y <span class="op">=</span> R<span class="op">-&gt;</span>z<span class="op">.</span>z <span class="op">=</span> <span class="fl">1.</span><span class="op">;</span></span>
<span id="cb5-47">    R<span class="op">-&gt;</span>y<span class="op">.</span>x <span class="op">=</span> R<span class="op">-&gt;</span>x<span class="op">.</span>y <span class="op">=</span> R<span class="op">-&gt;</span>z<span class="op">.</span>x <span class="op">=</span> R<span class="op">-&gt;</span>x<span class="op">.</span>z <span class="op">=</span> R<span class="op">-&gt;</span>z<span class="op">.</span>y <span class="op">=</span> R<span class="op">-&gt;</span>y<span class="op">.</span>z <span class="op">=</span> <span class="fl">0.</span><span class="op">;</span></span>
<span id="cb5-48">    Lambda<span class="op">-&gt;</span>x <span class="op">=</span> A<span class="op">-&gt;</span>x<span class="op">.</span>x<span class="op">;</span> Lambda<span class="op">-&gt;</span>y <span class="op">=</span> A<span class="op">-&gt;</span>y<span class="op">.</span>y<span class="op">;</span> Lambda<span class="op">-&gt;</span>z <span class="op">=</span> A<span class="op">-&gt;</span>z<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb5-49">    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb5-50">  <span class="op">}</span></span>
<span id="cb5-51"></span>
<span id="cb5-52">  <span class="co">// Compute eigenvalues using the eigen_decomposition function</span></span>
<span id="cb5-53">  <span class="dt">double</span> matrix<span class="op">[</span><span class="dv">3</span><span class="op">][</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb5-54">    <span class="op">{</span>A<span class="op">-&gt;</span>x<span class="op">.</span>x<span class="op">,</span> A<span class="op">-&gt;</span>x<span class="op">.</span>y<span class="op">,</span> A<span class="op">-&gt;</span>x<span class="op">.</span>z<span class="op">},</span></span>
<span id="cb5-55">    <span class="op">{</span>A<span class="op">-&gt;</span>y<span class="op">.</span>x<span class="op">,</span> A<span class="op">-&gt;</span>y<span class="op">.</span>y<span class="op">,</span> A<span class="op">-&gt;</span>y<span class="op">.</span>z<span class="op">},</span></span>
<span id="cb5-56">    <span class="op">{</span>A<span class="op">-&gt;</span>z<span class="op">.</span>x<span class="op">,</span> A<span class="op">-&gt;</span>z<span class="op">.</span>y<span class="op">,</span> A<span class="op">-&gt;</span>z<span class="op">.</span>z<span class="op">}</span></span>
<span id="cb5-57">  <span class="op">};</span></span>
<span id="cb5-58">  <span class="dt">double</span> eigenvectors<span class="op">[</span><span class="dv">3</span><span class="op">][</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb5-59">  <span class="dt">double</span> eigenvalues<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb5-60"></span>
<span id="cb5-61">  compute_eigensystem_symmetric_3x3<span class="op">(</span>matrix<span class="op">,</span> eigenvectors<span class="op">,</span> eigenvalues<span class="op">);</span></span>
<span id="cb5-62"></span>
<span id="cb5-63">  <span class="co">// Store eigenvalues and eigenvectors</span></span>
<span id="cb5-64">  Lambda<span class="op">-&gt;</span>x <span class="op">=</span> eigenvalues<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb5-65">  Lambda<span class="op">-&gt;</span>y <span class="op">=</span> eigenvalues<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb5-66">  Lambda<span class="op">-&gt;</span>z <span class="op">=</span> eigenvalues<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb5-67"></span>
<span id="cb5-68">  R<span class="op">-&gt;</span>x<span class="op">.</span>x <span class="op">=</span> eigenvectors<span class="op">[</span><span class="dv">0</span><span class="op">][</span><span class="dv">0</span><span class="op">];</span> R<span class="op">-&gt;</span>x<span class="op">.</span>y <span class="op">=</span> eigenvectors<span class="op">[</span><span class="dv">0</span><span class="op">][</span><span class="dv">1</span><span class="op">];</span> R<span class="op">-&gt;</span>x<span class="op">.</span>z <span class="op">=</span> eigenvectors<span class="op">[</span><span class="dv">0</span><span class="op">][</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb5-69">  R<span class="op">-&gt;</span>y<span class="op">.</span>x <span class="op">=</span> eigenvectors<span class="op">[</span><span class="dv">1</span><span class="op">][</span><span class="dv">0</span><span class="op">];</span> R<span class="op">-&gt;</span>y<span class="op">.</span>y <span class="op">=</span> eigenvectors<span class="op">[</span><span class="dv">1</span><span class="op">][</span><span class="dv">1</span><span class="op">];</span> R<span class="op">-&gt;</span>y<span class="op">.</span>z <span class="op">=</span> eigenvectors<span class="op">[</span><span class="dv">1</span><span class="op">][</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb5-70">  R<span class="op">-&gt;</span>z<span class="op">.</span>x <span class="op">=</span> eigenvectors<span class="op">[</span><span class="dv">2</span><span class="op">][</span><span class="dv">0</span><span class="op">];</span> R<span class="op">-&gt;</span>z<span class="op">.</span>y <span class="op">=</span> eigenvectors<span class="op">[</span><span class="dv">2</span><span class="op">][</span><span class="dv">1</span><span class="op">];</span> R<span class="op">-&gt;</span>z<span class="op">.</span>z <span class="op">=</span> eigenvectors<span class="op">[</span><span class="dv">2</span><span class="op">][</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb5-71"></span>
<span id="cb5-72"><span class="op">}</span></span>
<span id="cb5-73"><span class="pp">#endif</span></span></code></pre></div></div>
                <p>The stress tensor depends on previous instants and
                has to be integrated in time. In the log-conformation
                scheme the advection of the stress tensor is
                circumvented, instead the conformation tensor, <span
                class="math inline">\(\mathbf{A}\)</span> (or more
                precisely the related variable <span
                class="math inline">\(\Psi\)</span>) is advanced in
                time.</p>
                <p>In what follows we will adopt a scheme similar to
                that of <a href="#hao2007">Hao &amp; Pan (2007)</a>. We
                use a split scheme, solving successively</p>
                <ol type="a">
                <li>the upper convective term: <span
                class="math display">\[
                \partial_t \Psi = 2 \mathbf{B} + (\Omega \cdot \Psi
                -\Psi \cdot \Omega)
                \]</span></li>
                <li>the advection term: <span class="math display">\[
                \partial_t \Psi + \nabla \cdot (\Psi \mathbf{u}) = 0
                \]</span></li>
                <li>the model term (but set in terms of the conformation
                tensor <span class="math inline">\(\mathbf{A}\)</span>).
                In an Oldroyd-B viscoelastic fluid, the model is <span
                class="math display">\[
                \partial_t \mathbf{A} = -\frac{\mathbf{f}_r
                (\mathbf{A})}{\lambda}
                \]</span></li>
                </ol>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><span class="pp">#if dimension ==</span></span></code></pre></div></div>
                <p>Advances the log-conformation tensor and updates the
                corresponding conformation and stress tensors.</p>
                <p>This event function performs three primary steps
                within the viscoelastic fluid simulation: - Diagonalizes
                the conformation tensor and computes its logarithm (Ψ)
                while applying eigenvalue clamping to ensure numerical
                stability. - Advances Ψ in time by incorporating the
                upper convective term computed from the velocity
                gradient, which is used to update the log-conformation
                tensor. - Recovers the physical conformation tensor and
                stress tensor by exponentiating the diagonalized
                eigenvalues and integrating the relaxation term.</p>
                <p>Note: Although the overall simulation targets 3D
                viscoelastic fluids, this implementation uses a 2D
                diagonalization routine.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb7-1">event tracer_advection<span class="op">(</span>i<span class="op">++)</span></span>
<span id="cb7-2"><span class="op">{</span></span>
<span id="cb7-3">  scalar Psi11 <span class="op">=</span> A11<span class="op">;</span></span>
<span id="cb7-4">  scalar Psi12 <span class="op">=</span> A12<span class="op">;</span></span>
<span id="cb7-5">  scalar Psi22 <span class="op">=</span> A22<span class="op">;</span></span></code></pre></div></div>
                <h3
                id="computation-of-psi-log-mathbfa-and-upper-convective-term">Computation
                of <span class="math inline">\(\Psi = \log
                \mathbf{A}\)</span> and upper convective term</h3>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb8-1">  foreach<span class="op">()</span> <span class="op">{</span></span></code></pre></div></div>
                <p>We assume that the stress tensor <span
                class="math inline">\(\mathbf{\tau}_p\)</span> depends
                on the conformation tensor <span
                class="math inline">\(\mathbf{A}\)</span> as follows
                <span class="math display">\[
                  \mathbf{\tau}_p = G_p (\mathbf{A}) =
                  G_p (\mathbf{A} - I)
                  \]</span></p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb9-1">    pseudo_t A <span class="op">=</span> <span class="op">{{</span>A11<span class="op">[],</span> A12<span class="op">[]},</span> <span class="op">{</span>A12<span class="op">[],</span> A22<span class="op">[]}};</span></span></code></pre></div></div>
                <p>The conformation tensor is diagonalized through the
                eigenvector tensor <span
                class="math inline">\(\mathbf{R}\)</span> and the
                eigenvalues diagonal tensor, <span
                class="math inline">\(\Lambda\)</span>.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb10-1">    pseudo_v Lambda<span class="op">;</span></span>
<span id="cb10-2">    init_pseudo_v<span class="op">(&amp;</span>Lambda<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb10-3">    pseudo_t R<span class="op">;</span></span>
<span id="cb10-4">    init_pseudo_t<span class="op">(&amp;</span>R<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb10-5">    diagonalization_2D <span class="op">(&amp;</span>Lambda<span class="op">,</span> <span class="op">&amp;</span>R<span class="op">,</span> <span class="op">&amp;</span>A<span class="op">);</span></span>
<span id="cb10-6"></span>
<span id="cb10-7">    <span class="co">/*</span></span>
<span id="cb10-8"><span class="co">    Check for negative eigenvalues and clamp them to EIGENVALUE_MIN.</span></span>
<span id="cb10-9"><span class="co">    This prevents numerical instabilities while maintaining physical meaning.</span></span>
<span id="cb10-10"><span class="co">    */</span></span>
<span id="cb10-11">    <span class="cf">if</span> <span class="op">(</span>Lambda<span class="op">.</span>x <span class="op">&lt;=</span> <span class="fl">0.</span> <span class="op">||</span> Lambda<span class="op">.</span>y <span class="op">&lt;=</span> <span class="fl">0.</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-12">      fprintf<span class="op">(</span>ferr<span class="op">,</span> <span class="st">&quot;WARNING: Negative eigenvalue detected at (</span><span class="sc">%g</span><span class="st">,</span><span class="sc">%g</span><span class="st">): [</span><span class="sc">%g</span><span class="st">,</span><span class="sc">%g</span><span class="st">]</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb10-13">              x<span class="op">,</span> y<span class="op">,</span> Lambda<span class="op">.</span>x<span class="op">,</span> Lambda<span class="op">.</span>y<span class="op">);</span></span>
<span id="cb10-14"></span>
<span id="cb10-15">      <span class="pp">#ifdef DEBUG_EIGENVALUES</span></span>
<span id="cb10-16">      atomic_increment<span class="op">(&amp;</span>eigenvalue_corrections<span class="op">);</span></span>
<span id="cb10-17">      <span class="pp">#endif</span></span>
<span id="cb10-18"></span>
<span id="cb10-19">      Lambda<span class="op">.</span>x <span class="op">=</span> max<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">,</span> EIGENVALUE_MIN<span class="op">);</span></span>
<span id="cb10-20">      Lambda<span class="op">.</span>y <span class="op">=</span> max<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">,</span> EIGENVALUE_MIN<span class="op">);</span></span>
<span id="cb10-21">    <span class="op">}</span></span></code></pre></div></div>
                <p><span class="math inline">\(\Psi = \log
                \mathbf{A}\)</span> is easily obtained after
                diagonalization, <span class="math inline">\(\Psi = R
                \cdot \log(\Lambda) \cdot R^T\)</span>.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb11-1">    Psi12<span class="op">[]</span> <span class="op">=</span> R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>log<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>log<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">);</span></span>
<span id="cb11-2">    Psi11<span class="op">[]</span> <span class="op">=</span> sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">);</span></span>
<span id="cb11-3">    Psi22<span class="op">[]</span> <span class="op">=</span> sq<span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>y<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">)</span> <span class="op">+</span> sq<span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">);</span></span></code></pre></div></div>
                <p>We now compute the upper convective term <span
                class="math inline">\(2 \mathbf{B} +
                (\Omega \cdot \Psi -\Psi \cdot \Omega)\)</span>.</p>
                <p>The diagonalization will be applied to the velocity
                gradient <span class="math inline">\((\nabla
                u)^T\)</span> to obtain the antisymmetric tensor <span
                class="math inline">\(\Omega\)</span> and the traceless,
                symmetric tensor, <span
                class="math inline">\(\mathbf{B}\)</span>. If the
                conformation tensor is <span
                class="math inline">\(\mathbf{I}\)</span>, <span
                class="math inline">\(\Omega = 0\)</span> and <span
                class="math inline">\(\mathbf{B}=
                \mathbf{D}\)</span>.</p>
                <p>Otherwise, compute M = R * (nablaU)^T * R^T, where
                nablaU is the velocity gradient tensor. Then,</p>
                <ol type="1">
                <li><p>Calculate omega using the off-diagonal elements
                of M and eigenvalues: omega = (Lambda.y<em>M.x.y +
                Lambda.x</em>M.y.x)/(Lambda.y - Lambda.x) This
                represents the rotation rate in the eigenvector
                basis.</p></li>
                <li><p>Transform omega back to physical space to get OM:
                OM = (R.x.x<em>R.y.y - R.x.y</em>R.y.x)*omega This gives
                us the rotation tensor Omega in the original coordinate
                system.</p></li>
                <li><p>Compute B tensor components using M and R: B is
                related to M and R through:</p>
                <p>In 2D: <span class="math display">\[
                B_{xx} = R_{xx}^2 M_{xx} + R_{xy}^2 M_{yy} \\
                B_{xy} = R_{xx}R_{yx} M_{xx} + R_{xy}R_{yy} M_{yy} \\
                B_{yx} = B_{xy} \\
                B_{yy} = -B_{xx}
                \]</span></p>
                <p>Where:</p>
                <ul>
                <li>R is the eigenvector matrix of the conformation
                tensor</li>
                <li>M is the velocity gradient tensor in the eigenvector
                basis</li>
                <li>The construction ensures B is symmetric and
                traceless</li>
                </ul></li>
                </ol>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb12-1">    pseudo_t B<span class="op">;</span></span>
<span id="cb12-2">    init_pseudo_t<span class="op">(&amp;</span>B<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb12-3">    <span class="dt">double</span> OM <span class="op">=</span> <span class="fl">0.</span><span class="op">;</span></span>
<span id="cb12-4">    <span class="cf">if</span> <span class="op">(</span>fabs<span class="op">(</span>Lambda<span class="op">.</span>x <span class="op">-</span> Lambda<span class="op">.</span>y<span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">1e-20</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-5">      B<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>y<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/(</span><span class="fl">4.</span><span class="op">*</span>Delta<span class="op">);</span></span>
<span id="cb12-6">      foreach_dimension<span class="op">()</span></span>
<span id="cb12-7">        B<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>x<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">])/(</span><span class="fl">2.</span><span class="op">*</span>Delta<span class="op">);</span></span>
<span id="cb12-8">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb12-9">      pseudo_t M<span class="op">;</span></span>
<span id="cb12-10">      init_pseudo_t<span class="op">(&amp;</span>M<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb12-11">      foreach_dimension<span class="op">()</span> <span class="op">{</span></span>
<span id="cb12-12">        M<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> <span class="op">(</span>sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">)*(</span>u<span class="op">.</span>x<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[-</span><span class="dv">1</span><span class="op">])</span> <span class="op">+</span></span>
<span id="cb12-13">        sq<span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">)*(</span>u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])</span> <span class="op">+</span></span>
<span id="cb12-14">        R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*(</span>u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]</span> <span class="op">+</span></span>
<span id="cb12-15">        u<span class="op">.</span>y<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[-</span><span class="dv">1</span><span class="op">]))/(</span><span class="fl">2.</span><span class="op">*</span>Delta<span class="op">);</span></span>
<span id="cb12-16">        M<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> <span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*(</span>u<span class="op">.</span>x<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[-</span><span class="dv">1</span><span class="op">])</span> <span class="op">+</span></span>
<span id="cb12-17">        R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*(</span>u<span class="op">.</span>y<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[-</span><span class="dv">1</span><span class="op">])</span> <span class="op">+</span></span>
<span id="cb12-18">        R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*(</span>u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])</span> <span class="op">+</span></span>
<span id="cb12-19">        R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*(</span>u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]))/(</span><span class="fl">2.</span><span class="op">*</span>Delta<span class="op">);</span></span>
<span id="cb12-20">      <span class="op">}</span></span>
<span id="cb12-21">      <span class="dt">double</span> omega <span class="op">=</span> <span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">*</span>M<span class="op">.</span>x<span class="op">.</span>y <span class="op">+</span> Lambda<span class="op">.</span>x<span class="op">*</span>M<span class="op">.</span>y<span class="op">.</span>x<span class="op">)/(</span>Lambda<span class="op">.</span>y <span class="op">-</span> Lambda<span class="op">.</span>x<span class="op">);</span></span>
<span id="cb12-22">      OM <span class="op">=</span> <span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>y <span class="op">-</span> R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">)*</span>omega<span class="op">;</span></span>
<span id="cb12-23"></span>
<span id="cb12-24">      B<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> M<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>x <span class="op">+</span> M<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb12-25">      foreach_dimension<span class="op">()</span></span>
<span id="cb12-26">        B<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> M<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">)+</span>M<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">);</span></span>
<span id="cb12-27">    <span class="op">}</span></span></code></pre></div></div>
                <p>We now advance <span
                class="math inline">\(\Psi\)</span> in time, adding the
                upper convective contribution.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb13-1">    <span class="dt">double</span> s <span class="op">=</span> <span class="op">-</span>Psi12<span class="op">[];</span></span>
<span id="cb13-2">    Psi12<span class="op">[]</span> <span class="op">+=</span> dt <span class="op">*</span> <span class="op">(</span><span class="fl">2.</span> <span class="op">*</span> B<span class="op">.</span>x<span class="op">.</span>y <span class="op">+</span> OM <span class="op">*</span> <span class="op">(</span>Psi22<span class="op">[]</span> <span class="op">-</span> Psi11<span class="op">[]));</span></span>
<span id="cb13-3">    s <span class="op">*=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb13-4">    Psi11<span class="op">[]</span> <span class="op">+=</span> dt <span class="op">*</span> <span class="fl">2.</span> <span class="op">*</span> <span class="op">(</span>B<span class="op">.</span>x<span class="op">.</span>x <span class="op">+</span> s <span class="op">*</span> OM<span class="op">);</span></span>
<span id="cb13-5">    s <span class="op">*=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb13-6">    Psi22<span class="op">[]</span> <span class="op">+=</span> dt <span class="op">*</span> <span class="fl">2.</span> <span class="op">*</span> <span class="op">(</span>B<span class="op">.</span>y<span class="op">.</span>y <span class="op">+</span> s <span class="op">*</span> OM<span class="op">);</span></span>
<span id="cb13-7">  <span class="op">}</span></span></code></pre></div></div>
                <h3 id="advection-of-psi">Advection of <span
                class="math inline">\(\Psi\)</span></h3>
                <p>We proceed with step (b), the advection of the log of
                the conformation tensor <span
                class="math inline">\(\Psi\)</span>.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb14-1">  advection <span class="op">({</span>Psi11<span class="op">,</span> Psi12<span class="op">,</span> Psi22<span class="op">},</span> uf<span class="op">,</span> dt<span class="op">);</span></span></code></pre></div></div>
                <h3 id="convert-back-to-aij">Convert back to Aij</h3>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb15-1">  foreach<span class="op">()</span> <span class="op">{</span></span></code></pre></div></div>
                <p>It is time to undo the log-conformation, again by
                diagonalization, to recover the conformation tensor
                <span class="math inline">\(\mathbf{A}\)</span> and to
                perform step (c).</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb16-1">    pseudo_t A <span class="op">=</span> <span class="op">{{</span>Psi11<span class="op">[],</span> Psi12<span class="op">[]},</span> <span class="op">{</span>Psi12<span class="op">[],</span> Psi22<span class="op">[]}},</span> R<span class="op">;</span></span>
<span id="cb16-2">    init_pseudo_t<span class="op">(&amp;</span>R<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb16-3">    pseudo_v Lambda<span class="op">;</span></span>
<span id="cb16-4">    init_pseudo_v<span class="op">(&amp;</span>Lambda<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb16-5"></span>
<span id="cb16-6">    diagonalization_2D <span class="op">(&amp;</span>Lambda<span class="op">,</span> <span class="op">&amp;</span>R<span class="op">,</span> <span class="op">&amp;</span>A<span class="op">);</span></span>
<span id="cb16-7">    Lambda<span class="op">.</span>x <span class="op">=</span> exp<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">),</span> Lambda<span class="op">.</span>y <span class="op">=</span> exp<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">);</span></span>
<span id="cb16-8"></span>
<span id="cb16-9">    A<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>Lambda<span class="op">.</span>x <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>Lambda<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb16-10">    foreach_dimension<span class="op">()</span></span>
<span id="cb16-11">      A<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">)*</span>Lambda<span class="op">.</span>x <span class="op">+</span> sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">)*</span>Lambda<span class="op">.</span>y<span class="op">;</span></span></code></pre></div></div>
                <p>We perform now step (c) by integrating <span
                class="math inline">\(\mathbf{A}_t = -\mathbf{f}_r
                (\mathbf{A})/\lambda\)</span> to obtain <span
                class="math inline">\(\mathbf{A}^{n+1}\)</span>. This
                step is analytic, <span class="math display">\[
                \int_{t^n}^{t^{n+1}}\frac{d \mathbf{A}}{\mathbf{I}-
                \mathbf{A}} =
                \frac{\Delta t}{\lambda}
                \]</span></p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb17-1">    <span class="dt">double</span> intFactor <span class="op">=</span> <span class="op">(</span>lambda<span class="op">[]</span> <span class="op">!=</span> <span class="fl">0.</span> <span class="op">?</span> <span class="op">(</span>lambda<span class="op">[]</span> <span class="op">==</span> <span class="fl">1e30</span> <span class="op">?</span> <span class="dv">1</span><span class="op">:</span> exp<span class="op">(-</span>dt<span class="op">/</span>lambda<span class="op">[])):</span> <span class="fl">0.</span><span class="op">);</span></span>
<span id="cb17-2"></span>
<span id="cb17-3">    A<span class="op">.</span>x<span class="op">.</span>y <span class="op">*=</span> intFactor<span class="op">;</span></span>
<span id="cb17-4">    foreach_dimension<span class="op">()</span></span>
<span id="cb17-5">      A<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> <span class="op">(</span><span class="fl">1.</span> <span class="op">-</span> intFactor<span class="op">)</span> <span class="op">+</span> A<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>intFactor<span class="op">;</span></span></code></pre></div></div>
                <p>Then the Conformation tensor <span
                class="math inline">\(\mathcal{A}_p^{n+1}\)</span> is
                restored from <span
                class="math inline">\(\mathbf{A}^{n+1}\)</span>.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb18-1">    A12<span class="op">[]</span> <span class="op">=</span> A<span class="op">.</span>x<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb18-2">    T12<span class="op">[]</span> <span class="op">=</span> Gp<span class="op">[]*</span>A<span class="op">.</span>x<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb18-3">    A11<span class="op">[]</span> <span class="op">=</span> A<span class="op">.</span>x<span class="op">.</span>x<span class="op">;</span></span>
<span id="cb18-4">    T11<span class="op">[]</span> <span class="op">=</span> Gp<span class="op">[]*(</span>A<span class="op">.</span>x<span class="op">.</span>x <span class="op">-</span> <span class="fl">1.</span><span class="op">);</span></span>
<span id="cb18-5">    A22<span class="op">[]</span> <span class="op">=</span> A<span class="op">.</span>y<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb18-6">    T22<span class="op">[]</span> <span class="op">=</span> Gp<span class="op">[]*(</span>A<span class="op">.</span>y<span class="op">.</span>y <span class="op">-</span> <span class="fl">1.</span><span class="op">);</span></span>
<span id="cb18-7">  <span class="op">}</span></span>
<span id="cb18-8"><span class="op">}</span></span>
<span id="cb18-9"></span>
<span id="cb18-10"><span class="pp">#elif dimension ==</span></span></code></pre></div></div>
                <p>Advances the log-conformation tensor and computes the
                corresponding conformation and stress tensors for 3D
                viscoelastic fluid simulations.</p>
                <p>This event function performs a two-step update for
                the viscoelastic fluid model using the log-conformation
                method. In the first part, it computes the logarithm of
                the conformation tensor <span
                class="math inline">\(\Psi\)</span> from A by: -
                Diagonalizing A to obtain eigenvalues (<span
                class="math inline">\(\Lambda\)</span>) and eigenvectors
                (R). - Clamping any negative eigenvalues to prevent
                numerical instabilities (using EIGENVALUE_MIN). -
                Evaluating <span class="math inline">\(\Psi =
                \log(A)\)</span> and incorporating the upper convective
                contribution via the symmetric tensor B and the
                skew-symmetric tensor <span
                class="math inline">\(\Omega\)</span>.</p>
                <p><span class="math inline">\(\Psi\)</span> is then
                advanced in time using central difference approximations
                for the velocity gradients, where degenerate eigenvalue
                cases are handled with simplified calculations.</p>
                <p>In the second part, the function converts the updated
                log-conformation tensor back to the conformation tensor
                A by exponentiating the eigenvalues and applies the
                relaxation factor derived from the relaxation time.
                Finally, it computes the polymeric stress tensor T from
                A.</p>
                <p>Warnings are printed if negative eigenvalues are
                detected, and a debug counter is incremented when
                debugging is enabled.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb19-1">event tracer_advection<span class="op">(</span>i<span class="op">++)</span></span>
<span id="cb19-2"><span class="op">{</span></span></code></pre></div></div>
                <h3
                id="computation-of-psi-log-mathbfa-and-upper-convective-term-1">Computation
                of <span class="math inline">\(\Psi = \log
                \mathbf{A}\)</span> and upper convective term</h3>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb20-1">  <span class="co">// start by declaring the scalar variables that will store the components of $\Psi$</span></span>
<span id="cb20-2">  scalar Psi11 <span class="op">=</span> A11<span class="op">,</span> Psi12 <span class="op">=</span> A12<span class="op">,</span> Psi13 <span class="op">=</span> A13<span class="op">,</span></span>
<span id="cb20-3">         Psi22 <span class="op">=</span> A22<span class="op">,</span> Psi23 <span class="op">=</span> A23<span class="op">,</span> Psi33 <span class="op">=</span> A33<span class="op">;</span></span>
<span id="cb20-4"></span>
<span id="cb20-5">  foreach<span class="op">()</span> <span class="op">{</span></span>
<span id="cb20-6">    pseudo_t3d A<span class="op">,</span> R<span class="op">;</span></span>
<span id="cb20-7">    init_pseudo_t3d<span class="op">(&amp;</span>R<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb20-8">    pseudo_v3d Lambda<span class="op">;</span></span>
<span id="cb20-9">    init_pseudo_v3d<span class="op">(&amp;</span>Lambda<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb20-10"></span>
<span id="cb20-11">    A<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> A11<span class="op">[];</span> A<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> A12<span class="op">[];</span> A<span class="op">.</span>x<span class="op">.</span>z <span class="op">=</span> A13<span class="op">[];</span></span>
<span id="cb20-12">    A<span class="op">.</span>y<span class="op">.</span>x <span class="op">=</span> A12<span class="op">[];</span> A<span class="op">.</span>y<span class="op">.</span>y <span class="op">=</span> A22<span class="op">[];</span> A<span class="op">.</span>y<span class="op">.</span>z <span class="op">=</span> A23<span class="op">[];</span></span>
<span id="cb20-13">    A<span class="op">.</span>z<span class="op">.</span>x <span class="op">=</span> A13<span class="op">[];</span> A<span class="op">.</span>z<span class="op">.</span>y <span class="op">=</span> A23<span class="op">[];</span> A<span class="op">.</span>z<span class="op">.</span>z <span class="op">=</span> A33<span class="op">[];</span></span>
<span id="cb20-14"></span>
<span id="cb20-15">    <span class="co">// Diagonalize the conformation tensor A to obtain the eigenvalues Lambda and eigenvectors R</span></span>
<span id="cb20-16">    diagonalization_3D <span class="op">(&amp;</span>Lambda<span class="op">,</span> <span class="op">&amp;</span>R<span class="op">,</span> <span class="op">&amp;</span>A<span class="op">);</span></span>
<span id="cb20-17"></span>
<span id="cb20-18">    <span class="co">/*</span></span>
<span id="cb20-19"><span class="co">    Check for negative eigenvalues and clamp them to EIGENVALUE_MIN.</span></span>
<span id="cb20-20"><span class="co">    This prevents numerical instabilities while maintaining physical meaning.</span></span>
<span id="cb20-21"><span class="co">    */</span></span>
<span id="cb20-22">    <span class="cf">if</span> <span class="op">(</span>Lambda<span class="op">.</span>x <span class="op">&lt;=</span> <span class="fl">0.</span> <span class="op">||</span> Lambda<span class="op">.</span>y <span class="op">&lt;=</span> <span class="fl">0.</span> <span class="op">||</span> Lambda<span class="op">.</span>z <span class="op">&lt;=</span> <span class="fl">0.</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-23">      fprintf<span class="op">(</span>ferr<span class="op">,</span> <span class="st">&quot;WARNING: Negative eigenvalue detected at (</span><span class="sc">%g</span><span class="st">,</span><span class="sc">%g</span><span class="st">,</span><span class="sc">%g</span><span class="st">): [</span><span class="sc">%g</span><span class="st">,</span><span class="sc">%g</span><span class="st">,</span><span class="sc">%g</span><span class="st">]</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb20-24">              x<span class="op">,</span> y<span class="op">,</span> z<span class="op">,</span> Lambda<span class="op">.</span>x<span class="op">,</span> Lambda<span class="op">.</span>y<span class="op">,</span> Lambda<span class="op">.</span>z<span class="op">);</span></span>
<span id="cb20-25"></span>
<span id="cb20-26">      <span class="pp">#ifdef DEBUG_EIGENVALUES</span></span>
<span id="cb20-27">      atomic_increment<span class="op">(&amp;</span>eigenvalue_corrections<span class="op">);</span></span>
<span id="cb20-28">      <span class="pp">#endif</span></span>
<span id="cb20-29"></span>
<span id="cb20-30">      Lambda<span class="op">.</span>x <span class="op">=</span> max<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">,</span> EIGENVALUE_MIN<span class="op">);</span></span>
<span id="cb20-31">      Lambda<span class="op">.</span>y <span class="op">=</span> max<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">,</span> EIGENVALUE_MIN<span class="op">);</span></span>
<span id="cb20-32">      Lambda<span class="op">.</span>z <span class="op">=</span> max<span class="op">(</span>Lambda<span class="op">.</span>z<span class="op">,</span> EIGENVALUE_MIN<span class="op">);</span></span>
<span id="cb20-33">    <span class="op">}</span></span>
<span id="cb20-34"></span>
<span id="cb20-35">    <span class="co">// Compute Psi = log(A) = R * log(Lambda) * R^T</span></span>
<span id="cb20-36">    Psi11<span class="op">[]</span> <span class="op">=</span> sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">)</span> <span class="op">+</span> sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>z<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>z<span class="op">);</span></span>
<span id="cb20-37">    Psi22<span class="op">[]</span> <span class="op">=</span> sq<span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> sq<span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>y<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">)</span> <span class="op">+</span> sq<span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>z<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>z<span class="op">);</span></span>
<span id="cb20-38">    Psi33<span class="op">[]</span> <span class="op">=</span> sq<span class="op">(</span>R<span class="op">.</span>z<span class="op">.</span>x<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> sq<span class="op">(</span>R<span class="op">.</span>z<span class="op">.</span>y<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">)</span> <span class="op">+</span> sq<span class="op">(</span>R<span class="op">.</span>z<span class="op">.</span>z<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>z<span class="op">);</span></span>
<span id="cb20-39"></span>
<span id="cb20-40">    Psi12<span class="op">[]</span> <span class="op">=</span> R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>log<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>log<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">)</span> <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>z<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>z<span class="op">*</span>log<span class="op">(</span>Lambda<span class="op">.</span>z<span class="op">);</span></span>
<span id="cb20-41">    Psi13<span class="op">[]</span> <span class="op">=</span> R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>z<span class="op">.</span>x<span class="op">*</span>log<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>z<span class="op">.</span>y<span class="op">*</span>log<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">)</span> <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>z<span class="op">*</span>R<span class="op">.</span>z<span class="op">.</span>z<span class="op">*</span>log<span class="op">(</span>Lambda<span class="op">.</span>z<span class="op">);</span></span>
<span id="cb20-42">    Psi23<span class="op">[]</span> <span class="op">=</span> R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>z<span class="op">.</span>x<span class="op">*</span>log<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>z<span class="op">.</span>y<span class="op">*</span>log<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">)</span> <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>z<span class="op">*</span>R<span class="op">.</span>z<span class="op">.</span>z<span class="op">*</span>log<span class="op">(</span>Lambda<span class="op">.</span>z<span class="op">);</span></span>
<span id="cb20-43"></span>
<span id="cb20-44">    <span class="co">// Compute B and Omega tensors (3D version)</span></span>
<span id="cb20-45">    pseudo_t3d B<span class="op">,</span> M<span class="op">,</span> Omega<span class="op">;</span></span>
<span id="cb20-46">    init_pseudo_t3d<span class="op">(&amp;</span>B<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb20-47">    init_pseudo_t3d<span class="op">(&amp;</span>M<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb20-48">    init_pseudo_t3d<span class="op">(&amp;</span>Omega<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb20-49"></span>
<span id="cb20-50">    <span class="co">// Check if any pair of eigenvalues are numerically equal (within a small tolerance)</span></span>
<span id="cb20-51">    <span class="cf">if</span> <span class="op">(</span>fabs<span class="op">(</span>Lambda<span class="op">.</span>x <span class="op">-</span> Lambda<span class="op">.</span>y<span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">1e-20</span> <span class="op">||</span> fabs<span class="op">(</span>Lambda<span class="op">.</span>y <span class="op">-</span> Lambda<span class="op">.</span>z<span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">1e-20</span> <span class="op">||</span> fabs<span class="op">(</span>Lambda<span class="op">.</span>z <span class="op">-</span> Lambda<span class="op">.</span>x<span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">1e-20</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-52">      <span class="co">// In case of equal eigenvalues, the calculations for B and Omega simplify significantly</span></span>
<span id="cb20-53">      <span class="co">// B is grad U and Omega is zero.</span></span>
<span id="cb20-54"></span>
<span id="cb20-55">      <span class="co">// Compute off-diagonal elements of B using central differences</span></span>
<span id="cb20-56">      <span class="co">// These represent the symmetric part of the velocity gradient tensor</span></span>
<span id="cb20-57">      B<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>y<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">])/(</span><span class="fl">4.</span><span class="op">*</span>Delta<span class="op">);</span>  <span class="co">// (dv/dx + du/dy)/2</span></span>
<span id="cb20-58">      B<span class="op">.</span>x<span class="op">.</span>z <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>z<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>z<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/(</span><span class="fl">4.</span><span class="op">*</span>Delta<span class="op">);</span>  <span class="co">// (dw/dx + du/dz)/2</span></span>
<span id="cb20-59">      B<span class="op">.</span>y<span class="op">.</span>z <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>z<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>z<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/(</span><span class="fl">4.</span><span class="op">*</span>Delta<span class="op">);</span>  <span class="co">// (dw/dy + dv/dz)/2</span></span>
<span id="cb20-60"></span>
<span id="cb20-61">      <span class="co">// Compute diagonal elements of B</span></span>
<span id="cb20-62">      <span class="co">// These represent the normal strain rates</span></span>
<span id="cb20-63">      B<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>x<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">])/(</span><span class="fl">2.</span><span class="op">*</span>Delta<span class="op">);</span>  <span class="co">// du/dx</span></span>
<span id="cb20-64">      B<span class="op">.</span>y<span class="op">.</span>y <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">])/(</span><span class="fl">2.</span><span class="op">*</span>Delta<span class="op">);</span>  <span class="co">// dv/dy</span></span>
<span id="cb20-65">      B<span class="op">.</span>z<span class="op">.</span>z <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>z<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>z<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/(</span><span class="fl">2.</span><span class="op">*</span>Delta<span class="op">);</span>  <span class="co">// dw/dz</span></span>
<span id="cb20-66"></span>
<span id="cb20-67">      <span class="co">// Set all components of Omega to zero</span></span>
<span id="cb20-68">      <span class="co">// This is because Omega represents the antisymmetric part of the velocity gradient tensor,</span></span>
<span id="cb20-69">      <span class="co">// which vanishes when eigenvalues are equal</span></span>
<span id="cb20-70">      Omega<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> Omega<span class="op">.</span>x<span class="op">.</span>z <span class="op">=</span> Omega<span class="op">.</span>y<span class="op">.</span>z <span class="op">=</span> Omega<span class="op">.</span>y<span class="op">.</span>x <span class="op">=</span> Omega<span class="op">.</span>z<span class="op">.</span>x <span class="op">=</span> Omega<span class="op">.</span>z<span class="op">.</span>y <span class="op">=</span> <span class="fl">0.</span><span class="op">;</span></span>
<span id="cb20-71"></span>
<span id="cb20-72">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb20-73"></span>
<span id="cb20-74">      <span class="co">/*</span></span>
<span id="cb20-75"><span class="co">      </span><span class="al">###</span><span class="co"> Compute the velocity gradient tensor components using central differences</span></span>
<span id="cb20-76"><span class="co">      - These represent the spatial derivatives of each velocity component</span></span>
<span id="cb20-77"><span class="co">      - These gradients form the velocity gradient tensor (nablaU):</span></span>
<span id="cb20-78"><span class="co">      [ dudx  dudy  dudz ]</span></span>
<span id="cb20-79"><span class="co">      [ dvdx  dvdy  dvdz ]</span></span>
<span id="cb20-80"><span class="co">      [ dwdx  dwdy  dwdz ]</span></span>
<span id="cb20-81"><span class="co">      */</span></span>
<span id="cb20-82"></span>
<span id="cb20-83">      <span class="co">// Derivatives of u (x-component of velocity)</span></span>
<span id="cb20-84">      <span class="dt">double</span> dudx <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>x<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">])/(</span><span class="fl">2.0</span><span class="op">*</span>Delta<span class="op">);</span>  <span class="co">// du/dx</span></span>
<span id="cb20-85">      <span class="dt">double</span> dudy <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">])/(</span><span class="fl">2.0</span><span class="op">*</span>Delta<span class="op">);</span>  <span class="co">// du/dy</span></span>
<span id="cb20-86">      <span class="dt">double</span> dudz <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/(</span><span class="fl">2.0</span><span class="op">*</span>Delta<span class="op">);</span>  <span class="co">// du/dz</span></span>
<span id="cb20-87"></span>
<span id="cb20-88">      <span class="co">// Derivatives of v (y-component of velocity)</span></span>
<span id="cb20-89">      <span class="dt">double</span> dvdx <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>y<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">])/(</span><span class="fl">2.0</span><span class="op">*</span>Delta<span class="op">);</span>  <span class="co">// dv/dx</span></span>
<span id="cb20-90">      <span class="dt">double</span> dvdy <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">])/(</span><span class="fl">2.0</span><span class="op">*</span>Delta<span class="op">);</span>  <span class="co">// dv/dy</span></span>
<span id="cb20-91">      <span class="dt">double</span> dvdz <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/(</span><span class="fl">2.0</span><span class="op">*</span>Delta<span class="op">);</span>  <span class="co">// dv/dz</span></span>
<span id="cb20-92"></span>
<span id="cb20-93">      <span class="co">// Derivatives of w (z-component of velocity)</span></span>
<span id="cb20-94">      <span class="dt">double</span> dwdx <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>z<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>z<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">])/(</span><span class="fl">2.0</span><span class="op">*</span>Delta<span class="op">);</span>  <span class="co">// dw/dx</span></span>
<span id="cb20-95">      <span class="dt">double</span> dwdy <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>z<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>z<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">])/(</span><span class="fl">2.0</span><span class="op">*</span>Delta<span class="op">);</span>  <span class="co">// dw/dy</span></span>
<span id="cb20-96">      <span class="dt">double</span> dwdz <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>z<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>z<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/(</span><span class="fl">2.0</span><span class="op">*</span>Delta<span class="op">);</span>  <span class="co">// dw/dz</span></span>
<span id="cb20-97"></span>
<span id="cb20-98">      <span class="co">/*</span></span>
<span id="cb20-99"><span class="co">      Calculate the M tensor through matrix multiplication: M = R * (nablaU)^T R^T. This represents the velocity gradient tensor transformed to the eigenvector basis of the conformation tensor.</span></span>
<span id="cb20-100"></span>
<span id="cb20-101"><span class="co">      * Steps:</span></span>
<span id="cb20-102"><span class="co">      1. Compute intermediate products (R * nablaU^T):</span></span>
<span id="cb20-103"><span class="co">         - Store row-wise products in Rx_gradU_*, Ry_gradU_*, Rz_gradU_*</span></span>
<span id="cb20-104"><span class="co">         - Each variable represents one row of the intermediate matrix</span></span>
<span id="cb20-105"><span class="co">      2. Multiply by R^T to obtain the final M tensor:</span></span>
<span id="cb20-106"><span class="co">         - M.i.j represents the (i,j) component of the transformed velocity gradient</span></span>
<span id="cb20-107"><span class="co">         - This transformation expresses the velocity gradient in the eigenvector basis</span></span>
<span id="cb20-108"><span class="co">         - The resulting M tensor is used to compute Omega (Ω) and B tensors, such that</span></span>
<span id="cb20-109"><span class="co">      */</span></span>
<span id="cb20-110"></span>
<span id="cb20-111">      <span class="co">// First, compute intermediate products of R and (nablaU)^T</span></span>
<span id="cb20-112">      <span class="dt">double</span> Rx_gradU_x <span class="op">=</span> R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>dudx <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>dvdx <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>z<span class="op">*</span>dwdx<span class="op">;</span></span>
<span id="cb20-113">      <span class="dt">double</span> Rx_gradU_y <span class="op">=</span> R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>dudy <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>dvdy <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>z<span class="op">*</span>dwdy<span class="op">;</span></span>
<span id="cb20-114">      <span class="dt">double</span> Rx_gradU_z <span class="op">=</span> R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>dudz <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>dvdz <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>z<span class="op">*</span>dwdz<span class="op">;</span></span>
<span id="cb20-115"></span>
<span id="cb20-116">      <span class="dt">double</span> Ry_gradU_x <span class="op">=</span> R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>dudx <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>dvdx <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>z<span class="op">*</span>dwdx<span class="op">;</span></span>
<span id="cb20-117">      <span class="dt">double</span> Ry_gradU_y <span class="op">=</span> R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>dudy <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>dvdy <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>z<span class="op">*</span>dwdy<span class="op">;</span></span>
<span id="cb20-118">      <span class="dt">double</span> Ry_gradU_z <span class="op">=</span> R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>dudz <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>dvdz <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>z<span class="op">*</span>dwdz<span class="op">;</span></span>
<span id="cb20-119"></span>
<span id="cb20-120">      <span class="dt">double</span> Rz_gradU_x <span class="op">=</span> R<span class="op">.</span>z<span class="op">.</span>x<span class="op">*</span>dudx <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>y<span class="op">*</span>dvdx <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>z<span class="op">*</span>dwdx<span class="op">;</span></span>
<span id="cb20-121">      <span class="dt">double</span> Rz_gradU_y <span class="op">=</span> R<span class="op">.</span>z<span class="op">.</span>x<span class="op">*</span>dudy <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>y<span class="op">*</span>dvdy <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>z<span class="op">*</span>dwdy<span class="op">;</span></span>
<span id="cb20-122">      <span class="dt">double</span> Rz_gradU_z <span class="op">=</span> R<span class="op">.</span>z<span class="op">.</span>x<span class="op">*</span>dudz <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>y<span class="op">*</span>dvdz <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>z<span class="op">*</span>dwdz<span class="op">;</span></span>
<span id="cb20-123"></span>
<span id="cb20-124">      <span class="co">// Now compute M components by multiplying the intermediate products with R^T</span></span>
<span id="cb20-125">      M<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>Rx_gradU_x <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>Rx_gradU_y <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>z<span class="op">*</span>Rx_gradU_z<span class="op">;</span></span>
<span id="cb20-126">      M<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>Ry_gradU_x <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>Ry_gradU_y <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>z<span class="op">*</span>Ry_gradU_z<span class="op">;</span></span>
<span id="cb20-127">      M<span class="op">.</span>x<span class="op">.</span>z <span class="op">=</span> R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>Rz_gradU_x <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>Rz_gradU_y <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>z<span class="op">*</span>Rz_gradU_z<span class="op">;</span></span>
<span id="cb20-128"></span>
<span id="cb20-129">      M<span class="op">.</span>y<span class="op">.</span>x <span class="op">=</span> R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>Rx_gradU_x <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>Rx_gradU_y <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>z<span class="op">*</span>Rx_gradU_z<span class="op">;</span></span>
<span id="cb20-130">      M<span class="op">.</span>y<span class="op">.</span>y <span class="op">=</span> R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>Ry_gradU_x <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>Ry_gradU_y <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>z<span class="op">*</span>Ry_gradU_z<span class="op">;</span></span>
<span id="cb20-131">      M<span class="op">.</span>y<span class="op">.</span>z <span class="op">=</span> R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>Rz_gradU_x <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>Rz_gradU_y <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>z<span class="op">*</span>Rz_gradU_z<span class="op">;</span></span>
<span id="cb20-132"></span>
<span id="cb20-133">      M<span class="op">.</span>z<span class="op">.</span>x <span class="op">=</span> R<span class="op">.</span>z<span class="op">.</span>x<span class="op">*</span>Rx_gradU_x <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>y<span class="op">*</span>Rx_gradU_y <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>z<span class="op">*</span>Rx_gradU_z<span class="op">;</span></span>
<span id="cb20-134">      M<span class="op">.</span>z<span class="op">.</span>y <span class="op">=</span> R<span class="op">.</span>z<span class="op">.</span>x<span class="op">*</span>Ry_gradU_x <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>y<span class="op">*</span>Ry_gradU_y <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>z<span class="op">*</span>Ry_gradU_z<span class="op">;</span></span>
<span id="cb20-135">      M<span class="op">.</span>z<span class="op">.</span>z <span class="op">=</span> R<span class="op">.</span>z<span class="op">.</span>x<span class="op">*</span>Rz_gradU_x <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>y<span class="op">*</span>Rz_gradU_y <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>z<span class="op">*</span>Rz_gradU_z<span class="op">;</span></span>
<span id="cb20-136"></span>
<span id="cb20-137">      <span class="co">// Compute the off-diagonal elements of the Omega tensor in the eigenvector basis</span></span>
<span id="cb20-138">      <span class="dt">double</span> omega_xy <span class="op">=</span> <span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">*</span>M<span class="op">.</span>x<span class="op">.</span>y <span class="op">+</span> Lambda<span class="op">.</span>x<span class="op">*</span>M<span class="op">.</span>y<span class="op">.</span>x<span class="op">)/(</span>Lambda<span class="op">.</span>y <span class="op">-</span> Lambda<span class="op">.</span>x<span class="op">);</span></span>
<span id="cb20-139">      <span class="dt">double</span> omega_xz <span class="op">=</span> <span class="op">(</span>Lambda<span class="op">.</span>z<span class="op">*</span>M<span class="op">.</span>x<span class="op">.</span>z <span class="op">+</span> Lambda<span class="op">.</span>x<span class="op">*</span>M<span class="op">.</span>z<span class="op">.</span>x<span class="op">)/(</span>Lambda<span class="op">.</span>z <span class="op">-</span> Lambda<span class="op">.</span>x<span class="op">);</span></span>
<span id="cb20-140">      <span class="dt">double</span> omega_yz <span class="op">=</span> <span class="op">(</span>Lambda<span class="op">.</span>z<span class="op">*</span>M<span class="op">.</span>y<span class="op">.</span>z <span class="op">+</span> Lambda<span class="op">.</span>y<span class="op">*</span>M<span class="op">.</span>z<span class="op">.</span>y<span class="op">)/(</span>Lambda<span class="op">.</span>z <span class="op">-</span> Lambda<span class="op">.</span>y<span class="op">);</span></span>
<span id="cb20-141"></span>
<span id="cb20-142">      <span class="co">// Calculate intermediate rotation combinations for each direction</span></span>
<span id="cb20-143">      <span class="co">// x-direction rotation combinations</span></span>
<span id="cb20-144">      <span class="dt">double</span> rot_x_xy_yz <span class="op">=</span> <span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>omega_xy <span class="op">-</span> R<span class="op">.</span>x<span class="op">.</span>z<span class="op">*</span>omega_yz<span class="op">);</span>  <span class="co">// xy rotation minus yz rotation, x components</span></span>
<span id="cb20-145">      <span class="dt">double</span> rot_x_xy_xz <span class="op">=</span> <span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>omega_xy <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>z<span class="op">*</span>omega_xz<span class="op">);</span>  <span class="co">// xy rotation plus xz rotation, x components</span></span>
<span id="cb20-146">      <span class="dt">double</span> rot_x_xz_yz <span class="op">=</span> <span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>omega_xz <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>omega_yz<span class="op">);</span>  <span class="co">// xz rotation plus yz rotation, x components</span></span>
<span id="cb20-147"></span>
<span id="cb20-148">      <span class="co">// y-direction rotation combinations</span></span>
<span id="cb20-149">      <span class="dt">double</span> rot_y_xy_yz <span class="op">=</span> <span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>omega_xy <span class="op">-</span> R<span class="op">.</span>y<span class="op">.</span>z<span class="op">*</span>omega_yz<span class="op">);</span>  <span class="co">// xy rotation minus yz rotation, y components</span></span>
<span id="cb20-150">      <span class="dt">double</span> rot_y_xy_xz <span class="op">=</span> <span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>omega_xy <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>z<span class="op">*</span>omega_xz<span class="op">);</span>  <span class="co">// xy rotation plus xz rotation, y components</span></span>
<span id="cb20-151">      <span class="dt">double</span> rot_y_xz_yz <span class="op">=</span> <span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>omega_xz <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>omega_yz<span class="op">);</span>  <span class="co">// xz rotation plus yz rotation, y components</span></span>
<span id="cb20-152"></span>
<span id="cb20-153">      <span class="co">// z-direction rotation combinations</span></span>
<span id="cb20-154">      <span class="dt">double</span> rot_z_xy_yz <span class="op">=</span> <span class="op">(</span>R<span class="op">.</span>z<span class="op">.</span>x<span class="op">*</span>omega_xy <span class="op">-</span> R<span class="op">.</span>z<span class="op">.</span>z<span class="op">*</span>omega_yz<span class="op">);</span>  <span class="co">// xy rotation minus yz rotation, z components</span></span>
<span id="cb20-155">      <span class="dt">double</span> rot_z_xy_xz <span class="op">=</span> <span class="op">(</span>R<span class="op">.</span>z<span class="op">.</span>y<span class="op">*</span>omega_xy <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>z<span class="op">*</span>omega_xz<span class="op">);</span>  <span class="co">// xy rotation plus xz rotation, z components</span></span>
<span id="cb20-156">      <span class="dt">double</span> rot_z_xz_yz <span class="op">=</span> <span class="op">(</span>R<span class="op">.</span>z<span class="op">.</span>x<span class="op">*</span>omega_xz <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>y<span class="op">*</span>omega_yz<span class="op">);</span>  <span class="co">// xz rotation plus yz rotation, z components</span></span></code></pre></div></div>
                <p>Calculate the components of the Omega tensor in the
                physical coordinate system</p>
                <p>The Omega tensor represents the rotational part of
                the velocity gradient tensor and is computed through the
                following steps:</p>
                <ol type="1">
                <li><p>We already have:</p>
                <ul>
                <li>R: eigenvector matrix of the conformation
                tensor</li>
                <li>rot_*_*_*: pre-computed rotation combinations for
                each direction</li>
                </ul></li>
                <li><p>Mathematical background: Omega = R * Omega_eigen
                * R^T where Omega_eigen is the rotation tensor in
                eigenvector space</p></li>
                <li><p>The components are calculated using the rotation
                combinations:</p>
                <ul>
                <li>rot_i_jk_lm represents combined rotations in the
                i-direction</li>
                <li>Each component Omega_ij is a linear combination of
                these rotations</li>
                </ul></li>
                </ol>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb21-1">      <span class="co">// Compute x-row components of Omega</span></span>
<span id="cb21-2">      Omega<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>rot_x_xy_yz  <span class="co">// xy-yz rotation contribution</span></span>
<span id="cb21-3">                <span class="op">-</span> R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>rot_x_xy_xz   <span class="co">// xy-xz rotation contribution</span></span>
<span id="cb21-4">                <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>z<span class="op">*</span>rot_x_xz_yz<span class="op">;</span>  <span class="co">// xz-yz rotation contribution</span></span>
<span id="cb21-5"></span>
<span id="cb21-6">      Omega<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>rot_x_xy_yz  <span class="co">// xy-yz rotation mapped to y-direction</span></span>
<span id="cb21-7">                <span class="op">-</span> R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>rot_x_xy_xz   <span class="co">// xy-xz rotation mapped to y-direction</span></span>
<span id="cb21-8">                <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>z<span class="op">*</span>rot_x_xz_yz<span class="op">;</span>  <span class="co">// xz-yz rotation mapped to y-direction</span></span>
<span id="cb21-9"></span>
<span id="cb21-10">      Omega<span class="op">.</span>x<span class="op">.</span>z <span class="op">=</span> R<span class="op">.</span>z<span class="op">.</span>y<span class="op">*</span>rot_x_xy_yz  <span class="co">// xy-yz rotation mapped to z-direction</span></span>
<span id="cb21-11">                <span class="op">-</span> R<span class="op">.</span>z<span class="op">.</span>x<span class="op">*</span>rot_x_xy_xz   <span class="co">// xy-xz rotation mapped to z-direction</span></span>
<span id="cb21-12">                <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>z<span class="op">*</span>rot_x_xz_yz<span class="op">;</span>  <span class="co">// xz-yz rotation mapped to z-direction</span></span>
<span id="cb21-13"></span>
<span id="cb21-14">      <span class="co">// Compute y-row components using similar pattern</span></span>
<span id="cb21-15">      Omega<span class="op">.</span>y<span class="op">.</span>x <span class="op">=</span> R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>rot_y_xy_yz <span class="op">-</span> R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>rot_y_xy_xz <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>z<span class="op">*</span>rot_y_xz_yz<span class="op">;</span></span>
<span id="cb21-16">      Omega<span class="op">.</span>y<span class="op">.</span>y <span class="op">=</span> R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>rot_y_xy_yz <span class="op">-</span> R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>rot_y_xy_xz <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>z<span class="op">*</span>rot_y_xz_yz<span class="op">;</span></span>
<span id="cb21-17">      Omega<span class="op">.</span>y<span class="op">.</span>z <span class="op">=</span> R<span class="op">.</span>z<span class="op">.</span>y<span class="op">*</span>rot_y_xy_yz <span class="op">-</span> R<span class="op">.</span>z<span class="op">.</span>x<span class="op">*</span>rot_y_xy_xz <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>z<span class="op">*</span>rot_y_xz_yz<span class="op">;</span></span>
<span id="cb21-18"></span>
<span id="cb21-19">      <span class="co">// Compute z-row components using similar pattern</span></span>
<span id="cb21-20">      Omega<span class="op">.</span>z<span class="op">.</span>x <span class="op">=</span> R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>rot_z_xy_yz <span class="op">-</span> R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>rot_z_xy_xz <span class="op">+</span> R<span class="op">.</span>x<span class="op">.</span>z<span class="op">*</span>rot_z_xz_yz<span class="op">;</span></span>
<span id="cb21-21">      Omega<span class="op">.</span>z<span class="op">.</span>y <span class="op">=</span> R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>rot_z_xy_yz <span class="op">-</span> R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>rot_z_xy_xz <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>z<span class="op">*</span>rot_z_xz_yz<span class="op">;</span></span>
<span id="cb21-22">      Omega<span class="op">.</span>z<span class="op">.</span>z <span class="op">=</span> R<span class="op">.</span>z<span class="op">.</span>y<span class="op">*</span>rot_z_xy_yz <span class="op">-</span> R<span class="op">.</span>z<span class="op">.</span>x<span class="op">*</span>rot_z_xy_xz <span class="op">+</span> R<span class="op">.</span>z<span class="op">.</span>z<span class="op">*</span>rot_z_xz_yz<span class="op">;</span></span></code></pre></div></div>
                <p>Note: The resulting Omega tensor is skew-symmetric,
                meaning: - Omega_ij = -Omega_ji This property is
                automatically satisfied by the construction above and is
                essential for preserving the physical meaning of
                rotation</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb22-1">      <span class="co">// Extract diagonal components of M (velocity gradient tensor in eigenvector basis)</span></span>
<span id="cb22-2">      <span class="dt">double</span> M_diag_x <span class="op">=</span> M<span class="op">.</span>x<span class="op">.</span>x<span class="op">,</span> M_diag_y <span class="op">=</span> M<span class="op">.</span>y<span class="op">.</span>y<span class="op">,</span> M_diag_z <span class="op">=</span> M<span class="op">.</span>z<span class="op">.</span>z<span class="op">;</span></span></code></pre></div></div>
                <p>Compute B tensor: B = R * diag(M) * R^T - This
                transforms the diagonal velocity gradient tensor back to
                the original coordinate system - B is symmetric, so we
                only need to compute the upper triangle</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb23-1">      <span class="co">// Compute diagonal elements of B</span></span>
<span id="cb23-2">      B<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> M_diag_x<span class="op">*</span>sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> M_diag_y<span class="op">*</span>sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">)</span> <span class="op">+</span> M_diag_z<span class="op">*</span>sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>z<span class="op">);</span></span>
<span id="cb23-3">      B<span class="op">.</span>y<span class="op">.</span>y <span class="op">=</span> M_diag_x<span class="op">*</span>sq<span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> M_diag_y<span class="op">*</span>sq<span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>y<span class="op">)</span> <span class="op">+</span> M_diag_z<span class="op">*</span>sq<span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>z<span class="op">);</span></span>
<span id="cb23-4">      B<span class="op">.</span>z<span class="op">.</span>z <span class="op">=</span> M_diag_x<span class="op">*</span>sq<span class="op">(</span>R<span class="op">.</span>z<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> M_diag_y<span class="op">*</span>sq<span class="op">(</span>R<span class="op">.</span>z<span class="op">.</span>y<span class="op">)</span> <span class="op">+</span> M_diag_z<span class="op">*</span>sq<span class="op">(</span>R<span class="op">.</span>z<span class="op">.</span>z<span class="op">);</span></span>
<span id="cb23-5"></span>
<span id="cb23-6">      <span class="co">// Compute off-diagonal elements of B (upper triangle)</span></span>
<span id="cb23-7">      B<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> M_diag_x<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>x <span class="op">+</span> M_diag_y<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>y <span class="op">+</span> M_diag_z<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>z<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb23-8">      B<span class="op">.</span>x<span class="op">.</span>z <span class="op">=</span> M_diag_x<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>z<span class="op">.</span>x <span class="op">+</span> M_diag_y<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>z<span class="op">.</span>y <span class="op">+</span> M_diag_z<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>z<span class="op">*</span>R<span class="op">.</span>z<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb23-9">      B<span class="op">.</span>y<span class="op">.</span>z <span class="op">=</span> M_diag_x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>z<span class="op">.</span>x <span class="op">+</span> M_diag_y<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>z<span class="op">.</span>y <span class="op">+</span> M_diag_z<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>z<span class="op">*</span>R<span class="op">.</span>z<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb23-10"></span>
<span id="cb23-11">      <span class="co">// Fill in lower triangle using symmetry of B</span></span>
<span id="cb23-12">      B<span class="op">.</span>y<span class="op">.</span>x <span class="op">=</span> B<span class="op">.</span>x<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb23-13">      B<span class="op">.</span>z<span class="op">.</span>x <span class="op">=</span> B<span class="op">.</span>x<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb23-14">      B<span class="op">.</span>z<span class="op">.</span>y <span class="op">=</span> B<span class="op">.</span>y<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb23-15">    <span class="op">}</span></span></code></pre></div></div>
                <p>We now advance <span
                class="math inline">\(\Psi\)</span> in time, adding the
                upper convective contribution. This step 1: _t = 2 +
                (-)</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb24-1">    <span class="co">// save old values of Psi components</span></span>
<span id="cb24-2">    <span class="dt">double</span> old_Psi11 <span class="op">=</span> Psi11<span class="op">[];</span></span>
<span id="cb24-3">    <span class="dt">double</span> old_Psi22 <span class="op">=</span> Psi22<span class="op">[];</span></span>
<span id="cb24-4">    <span class="dt">double</span> old_Psi33 <span class="op">=</span> Psi33<span class="op">[];</span></span>
<span id="cb24-5">    <span class="dt">double</span> old_Psi12 <span class="op">=</span> Psi12<span class="op">[];</span></span>
<span id="cb24-6">    <span class="dt">double</span> old_Psi13 <span class="op">=</span> Psi13<span class="op">[];</span></span>
<span id="cb24-7">    <span class="dt">double</span> old_Psi23 <span class="op">=</span> Psi23<span class="op">[];</span></span>
<span id="cb24-8"></span>
<span id="cb24-9">    <span class="co">// Psi11</span></span>
<span id="cb24-10">    Psi11<span class="op">[]</span> <span class="op">+=</span> dt <span class="op">*</span> <span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> B<span class="op">.</span>x<span class="op">.</span>x <span class="op">+</span> Omega<span class="op">.</span>x<span class="op">.</span>y <span class="op">*</span> old_Psi12 <span class="op">-</span> Omega<span class="op">.</span>y<span class="op">.</span>x <span class="op">*</span> old_Psi12 <span class="op">+</span> Omega<span class="op">.</span>x<span class="op">.</span>z <span class="op">*</span> old_Psi13 <span class="op">-</span> Omega<span class="op">.</span>z<span class="op">.</span>x <span class="op">*</span> old_Psi13<span class="op">);</span></span>
<span id="cb24-11">    <span class="co">// Psi22</span></span>
<span id="cb24-12">    Psi22<span class="op">[]</span> <span class="op">+=</span> dt <span class="op">*</span> <span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> B<span class="op">.</span>y<span class="op">.</span>y <span class="op">-</span> Omega<span class="op">.</span>x<span class="op">.</span>y <span class="op">*</span> old_Psi12 <span class="op">+</span> Omega<span class="op">.</span>y<span class="op">.</span>x <span class="op">*</span> old_Psi12 <span class="op">+</span> Omega<span class="op">.</span>y<span class="op">.</span>z <span class="op">*</span> old_Psi23 <span class="op">-</span> Omega<span class="op">.</span>z<span class="op">.</span>y <span class="op">*</span> old_Psi23<span class="op">);</span></span>
<span id="cb24-13">    <span class="co">// Psi33</span></span>
<span id="cb24-14">    Psi33<span class="op">[]</span> <span class="op">+=</span> dt <span class="op">*</span> <span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> B<span class="op">.</span>z<span class="op">.</span>z <span class="op">-</span> Omega<span class="op">.</span>x<span class="op">.</span>z <span class="op">*</span> old_Psi13 <span class="op">+</span> Omega<span class="op">.</span>z<span class="op">.</span>x <span class="op">*</span> old_Psi13 <span class="op">-</span> Omega<span class="op">.</span>y<span class="op">.</span>z <span class="op">*</span> old_Psi23 <span class="op">+</span> Omega<span class="op">.</span>z<span class="op">.</span>y <span class="op">*</span> old_Psi23<span class="op">);</span></span>
<span id="cb24-15">    <span class="co">// Psi12</span></span>
<span id="cb24-16">    Psi12<span class="op">[]</span> <span class="op">+=</span> dt <span class="op">*</span> <span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> B<span class="op">.</span>x<span class="op">.</span>y <span class="op">+</span> Omega<span class="op">.</span>x<span class="op">.</span>x <span class="op">*</span> old_Psi12 <span class="op">-</span> Omega<span class="op">.</span>x<span class="op">.</span>y <span class="op">*</span> old_Psi11 <span class="op">+</span> Omega<span class="op">.</span>x<span class="op">.</span>y <span class="op">*</span> old_Psi22 <span class="op">-</span> Omega<span class="op">.</span>y<span class="op">.</span>y <span class="op">*</span> old_Psi12 <span class="op">+</span> Omega<span class="op">.</span>x<span class="op">.</span>z <span class="op">*</span> old_Psi23 <span class="op">-</span> Omega<span class="op">.</span>z<span class="op">.</span>y <span class="op">*</span> old_Psi13<span class="op">);</span></span>
<span id="cb24-17">    <span class="co">// Psi13</span></span>
<span id="cb24-18">    Psi13<span class="op">[]</span> <span class="op">+=</span> dt <span class="op">*</span> <span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> B<span class="op">.</span>x<span class="op">.</span>z <span class="op">+</span> Omega<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>old_Psi13 <span class="op">-</span> Omega<span class="op">.</span>x<span class="op">.</span>z <span class="op">*</span> old_Psi11 <span class="op">+</span> Omega<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>old_Psi23 <span class="op">-</span> Omega<span class="op">.</span>y<span class="op">.</span>z<span class="op">*</span>old_Psi12 <span class="op">+</span> Omega<span class="op">.</span>x<span class="op">.</span>z <span class="op">*</span> old_Psi33 <span class="op">-</span> Omega<span class="op">.</span>z<span class="op">.</span>z <span class="op">*</span> old_Psi13<span class="op">);</span></span>
<span id="cb24-19">    <span class="co">// Psi23</span></span>
<span id="cb24-20">    Psi23<span class="op">[]</span> <span class="op">+=</span> dt <span class="op">*</span> <span class="op">(</span><span class="fl">2.0</span> <span class="op">*</span> B<span class="op">.</span>y<span class="op">.</span>z <span class="op">+</span> Omega<span class="op">.</span>y<span class="op">.</span>x <span class="op">*</span> old_Psi13 <span class="op">-</span> Omega<span class="op">.</span>x<span class="op">.</span>z <span class="op">*</span> old_Psi12 <span class="op">+</span> Omega<span class="op">.</span>y<span class="op">.</span>y <span class="op">*</span> old_Psi23 <span class="op">-</span> Omega<span class="op">.</span>y<span class="op">.</span>z <span class="op">*</span> old_Psi22 <span class="op">+</span> Omega<span class="op">.</span>y<span class="op">.</span>z <span class="op">*</span> old_Psi33 <span class="op">-</span> Omega<span class="op">.</span>z<span class="op">.</span>z <span class="op">*</span> old_Psi23<span class="op">);</span></span>
<span id="cb24-21"></span>
<span id="cb24-22">  <span class="op">}</span></span>
<span id="cb24-23"></span>
<span id="cb24-24">  <span class="co">// Advection of Psi, which is the log-conformation tensor</span></span>
<span id="cb24-25">  advection <span class="op">({</span>Psi11<span class="op">,</span> Psi12<span class="op">,</span> Psi13<span class="op">,</span> Psi22<span class="op">,</span> Psi23<span class="op">,</span> Psi33<span class="op">},</span> uf<span class="op">,</span> dt<span class="op">);</span></span></code></pre></div></div>
                <h3 id="convert-back-to-a-and-t">Convert back to A and
                T</h3>
                <p>We now convert the log-conformation tensor Psi back
                to the conformation tensor A and compute the stress
                tensor T. This process involves diagonalization,
                exponentiation of eigenvalues, and application of the
                relaxation factor.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb25-1">  foreach<span class="op">()</span> <span class="op">{</span></span>
<span id="cb25-2">    pseudo_t3d A<span class="op">,</span> R<span class="op">;</span></span>
<span id="cb25-3">    init_pseudo_t3d<span class="op">(&amp;</span>R<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb25-4">    pseudo_v3d Lambda<span class="op">;</span></span>
<span id="cb25-5">    init_pseudo_v3d<span class="op">(&amp;</span>Lambda<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb25-6"></span>
<span id="cb25-7">    <span class="co">// Reconstruct the log-conformation tensor from its components</span></span>
<span id="cb25-8">    A<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> Psi11<span class="op">[];</span> A<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> Psi12<span class="op">[];</span> A<span class="op">.</span>x<span class="op">.</span>z <span class="op">=</span> Psi13<span class="op">[];</span></span>
<span id="cb25-9">    A<span class="op">.</span>y<span class="op">.</span>x <span class="op">=</span> Psi12<span class="op">[];</span> A<span class="op">.</span>y<span class="op">.</span>y <span class="op">=</span> Psi22<span class="op">[];</span> A<span class="op">.</span>y<span class="op">.</span>z <span class="op">=</span> Psi23<span class="op">[];</span></span>
<span id="cb25-10">    A<span class="op">.</span>z<span class="op">.</span>x <span class="op">=</span> Psi13<span class="op">[];</span> A<span class="op">.</span>z<span class="op">.</span>y <span class="op">=</span> Psi23<span class="op">[];</span> A<span class="op">.</span>z<span class="op">.</span>z <span class="op">=</span> Psi33<span class="op">[];</span></span>
<span id="cb25-11"></span>
<span id="cb25-12">    <span class="co">// Diagonalize A to obtain eigenvalues and eigenvectors</span></span>
<span id="cb25-13">    diagonalization_3D<span class="op">(&amp;</span>Lambda<span class="op">,</span> <span class="op">&amp;</span>R<span class="op">,</span> <span class="op">&amp;</span>A<span class="op">);</span></span>
<span id="cb25-14"></span>
<span id="cb25-15">    <span class="co">// Exponentiate eigenvalues</span></span>
<span id="cb25-16">    Lambda<span class="op">.</span>x <span class="op">=</span> exp<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">);</span></span>
<span id="cb25-17">    Lambda<span class="op">.</span>y <span class="op">=</span> exp<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">);</span></span>
<span id="cb25-18">    Lambda<span class="op">.</span>z <span class="op">=</span> exp<span class="op">(</span>Lambda<span class="op">.</span>z<span class="op">);</span></span>
<span id="cb25-19"></span>
<span id="cb25-20">    <span class="co">// Reconstruct A using A = R * diag(Lambda) * R^T</span></span>
<span id="cb25-21">    A<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> Lambda<span class="op">.</span>x <span class="op">*</span> sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> Lambda<span class="op">.</span>y <span class="op">*</span> sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">)</span> <span class="op">+</span> Lambda<span class="op">.</span>z <span class="op">*</span> sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>z<span class="op">);</span></span>
<span id="cb25-22">    A<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> Lambda<span class="op">.</span>x <span class="op">*</span> R<span class="op">.</span>x<span class="op">.</span>x <span class="op">*</span> R<span class="op">.</span>y<span class="op">.</span>x <span class="op">+</span> Lambda<span class="op">.</span>y <span class="op">*</span> R<span class="op">.</span>x<span class="op">.</span>y <span class="op">*</span> R<span class="op">.</span>y<span class="op">.</span>y <span class="op">+</span> Lambda<span class="op">.</span>z <span class="op">*</span> R<span class="op">.</span>x<span class="op">.</span>z <span class="op">*</span> R<span class="op">.</span>y<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb25-23">    A<span class="op">.</span>y<span class="op">.</span>x <span class="op">=</span> A<span class="op">.</span>x<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb25-24">    A<span class="op">.</span>x<span class="op">.</span>z <span class="op">=</span> Lambda<span class="op">.</span>x <span class="op">*</span> R<span class="op">.</span>x<span class="op">.</span>x <span class="op">*</span> R<span class="op">.</span>z<span class="op">.</span>x <span class="op">+</span> Lambda<span class="op">.</span>y <span class="op">*</span> R<span class="op">.</span>x<span class="op">.</span>y <span class="op">*</span> R<span class="op">.</span>z<span class="op">.</span>y <span class="op">+</span> Lambda<span class="op">.</span>z <span class="op">*</span> R<span class="op">.</span>x<span class="op">.</span>z <span class="op">*</span> R<span class="op">.</span>z<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb25-25">    A<span class="op">.</span>z<span class="op">.</span>x <span class="op">=</span> A<span class="op">.</span>x<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb25-26">    A<span class="op">.</span>y<span class="op">.</span>y <span class="op">=</span> Lambda<span class="op">.</span>x <span class="op">*</span> sq<span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> Lambda<span class="op">.</span>y <span class="op">*</span> sq<span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>y<span class="op">)</span> <span class="op">+</span> Lambda<span class="op">.</span>z <span class="op">*</span> sq<span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>z<span class="op">);</span></span>
<span id="cb25-27">    A<span class="op">.</span>y<span class="op">.</span>z <span class="op">=</span> Lambda<span class="op">.</span>x <span class="op">*</span> R<span class="op">.</span>y<span class="op">.</span>x <span class="op">*</span> R<span class="op">.</span>z<span class="op">.</span>x <span class="op">+</span> Lambda<span class="op">.</span>y <span class="op">*</span> R<span class="op">.</span>y<span class="op">.</span>y <span class="op">*</span> R<span class="op">.</span>z<span class="op">.</span>y <span class="op">+</span> Lambda<span class="op">.</span>z <span class="op">*</span> R<span class="op">.</span>y<span class="op">.</span>z <span class="op">*</span> R<span class="op">.</span>z<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb25-28">    A<span class="op">.</span>z<span class="op">.</span>y <span class="op">=</span> A<span class="op">.</span>y<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb25-29">    A<span class="op">.</span>z<span class="op">.</span>z <span class="op">=</span> Lambda<span class="op">.</span>x <span class="op">*</span> sq<span class="op">(</span>R<span class="op">.</span>z<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> Lambda<span class="op">.</span>y <span class="op">*</span> sq<span class="op">(</span>R<span class="op">.</span>z<span class="op">.</span>y<span class="op">)</span> <span class="op">+</span> Lambda<span class="op">.</span>z <span class="op">*</span> sq<span class="op">(</span>R<span class="op">.</span>z<span class="op">.</span>z<span class="op">);</span></span>
<span id="cb25-30"></span>
<span id="cb25-31">    <span class="co">// Apply relaxation using the relaxation time lambda</span></span>
<span id="cb25-32">    <span class="dt">double</span> intFactor <span class="op">=</span> lambda<span class="op">[]</span> <span class="op">!=</span> <span class="fl">0.</span> <span class="op">?</span> exp<span class="op">(-</span>dt<span class="op">/</span>lambda<span class="op">[])</span> <span class="op">:</span> <span class="fl">0.</span><span class="op">;</span></span>
<span id="cb25-33"></span>
<span id="cb25-34">    A<span class="op">.</span>x<span class="op">.</span>y <span class="op">*=</span> intFactor<span class="op">;</span></span>
<span id="cb25-35">    A<span class="op">.</span>y<span class="op">.</span>x <span class="op">=</span> A<span class="op">.</span>x<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb25-36">    A<span class="op">.</span>x<span class="op">.</span>z <span class="op">*=</span> intFactor<span class="op">;</span></span>
<span id="cb25-37">    A<span class="op">.</span>z<span class="op">.</span>x <span class="op">=</span> A<span class="op">.</span>x<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb25-38">    A<span class="op">.</span>y<span class="op">.</span>z <span class="op">*=</span> intFactor<span class="op">;</span></span>
<span id="cb25-39">    A<span class="op">.</span>z<span class="op">.</span>y <span class="op">=</span> A<span class="op">.</span>y<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb25-40">    foreach_dimension<span class="op">()</span></span>
<span id="cb25-41">      A<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> <span class="fl">1.</span> <span class="op">+</span> <span class="op">(</span>A<span class="op">.</span>x<span class="op">.</span>x <span class="op">-</span> <span class="fl">1.</span><span class="op">)*</span>intFactor<span class="op">;</span></span></code></pre></div></div>
                <p>Get Aij from A. These commands might look repetitive.
                But, I do this so that in the future, generalization to
                tensor only form is easier.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb26-1">    <span class="co">// diagonal terms:</span></span>
<span id="cb26-2">    A11<span class="op">[]</span> <span class="op">=</span> A<span class="op">.</span>x<span class="op">.</span>x<span class="op">;</span></span>
<span id="cb26-3">    A22<span class="op">[]</span> <span class="op">=</span> A<span class="op">.</span>y<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb26-4">    A33<span class="op">[]</span> <span class="op">=</span> A<span class="op">.</span>z<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb26-5">    <span class="co">// off-diagonal terms:</span></span>
<span id="cb26-6">    A12<span class="op">[]</span> <span class="op">=</span> A<span class="op">.</span>x<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb26-7">    A13<span class="op">[]</span> <span class="op">=</span> A<span class="op">.</span>x<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb26-8">    A23<span class="op">[]</span> <span class="op">=</span> A<span class="op">.</span>y<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb26-9"></span>
<span id="cb26-10">    <span class="co">// Compute the stress tensor T using the polymer modulus Gp</span></span>
<span id="cb26-11">    T11<span class="op">[]</span> <span class="op">=</span> Gp<span class="op">[]*(</span>A<span class="op">.</span>x<span class="op">.</span>x <span class="op">-</span> <span class="fl">1.</span><span class="op">);</span></span>
<span id="cb26-12">    T22<span class="op">[]</span> <span class="op">=</span> Gp<span class="op">[]*(</span>A<span class="op">.</span>y<span class="op">.</span>y <span class="op">-</span> <span class="fl">1.</span><span class="op">);</span></span>
<span id="cb26-13">    T33<span class="op">[]</span> <span class="op">=</span> Gp<span class="op">[]*(</span>A<span class="op">.</span>z<span class="op">.</span>z <span class="op">-</span> <span class="fl">1.</span><span class="op">);</span></span>
<span id="cb26-14">    T12<span class="op">[]</span> <span class="op">=</span> Gp<span class="op">[]*</span>A<span class="op">.</span>x<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb26-15">    T13<span class="op">[]</span> <span class="op">=</span> Gp<span class="op">[]*</span>A<span class="op">.</span>x<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb26-16">    T23<span class="op">[]</span> <span class="op">=</span> Gp<span class="op">[]*</span>A<span class="op">.</span>y<span class="op">.</span>z<span class="op">;</span></span>
<span id="cb26-17">  <span class="op">}</span></span>
<span id="cb26-18"><span class="op">}</span></span>
<span id="cb26-19"><span class="pp">#endif</span></span></code></pre></div></div>
                <h2
                id="divergence-of-the-viscoelastic-stress-tensor">Divergence
                of the viscoelastic stress tensor</h2>
                <p>The viscoelastic stress tensor <span
                class="math inline">\(\mathbf{T}\)</span> is defined at
                cell centers, while the corresponding force
                (acceleration) is defined at cell faces. For each
                component of the momentum equation, we need to compute
                the divergence of the corresponding row of the stress
                tensor.</p>
                <p>For example, for the x-component in 3D:</p>
                <p><span class="math display">\[
                (\nabla \cdot \mathbf{T})_x = \partial_x T_{xx} +
                \partial_y T_{xy} + \partial_z T_{xz}
                \]</span></p>
                <p>The normal stress gradient (e.g. <span
                class="math inline">\(\partial_x T_{xx}\)</span>) is
                computed directly from cell-centered values. The shear
                stress gradients (e.g. <span
                class="math inline">\(\partial_y T_{xy}\)</span>) are
                computed using vertex-averaged values to avoid
                checkerboard instabilities.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb27-1">event acceleration <span class="op">(</span>i<span class="op">++)</span></span>
<span id="cb27-2"><span class="op">{</span></span>
<span id="cb27-3">  face vector av <span class="op">=</span> a<span class="op">;</span></span>
<span id="cb27-4"></span>
<span id="cb27-5"><span class="pp">#if dimension ==</span></span>
<span id="cb27-6">  <span class="co">// 2D implementation</span></span>
<span id="cb27-7">  foreach_face<span class="op">(</span>x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-8">    <span class="cf">if</span> <span class="op">(</span>fm<span class="op">.</span>x<span class="op">[]</span> <span class="op">&gt;</span> <span class="fl">1e-20</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-9">      <span class="co">// y-gradient of T12 (shear stress)</span></span>
<span id="cb27-10">      <span class="dt">double</span> shearX <span class="op">=</span> <span class="op">(</span>T12<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">+</span> T12<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span></span>
<span id="cb27-11">                       T12<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> T12<span class="op">[-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/</span><span class="fl">4.</span><span class="op">;</span></span>
<span id="cb27-12">      <span class="co">// x-gradient of T11 (normal stress)</span></span>
<span id="cb27-13">      <span class="dt">double</span> gradX_T11 <span class="op">=</span> cm<span class="op">[]*</span>T11<span class="op">[]</span> <span class="op">-</span> cm<span class="op">[-</span><span class="dv">1</span><span class="op">]*</span>T11<span class="op">[-</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb27-14"></span>
<span id="cb27-15">      av<span class="op">.</span>x<span class="op">[]</span> <span class="op">+=</span> <span class="op">(</span>shearX <span class="op">+</span> gradX_T11<span class="op">)*</span>alpha<span class="op">.</span>x<span class="op">[]/(</span>sq<span class="op">(</span>fm<span class="op">.</span>x<span class="op">[])*</span>Delta<span class="op">);</span></span>
<span id="cb27-16">    <span class="op">}</span></span>
<span id="cb27-17">  <span class="op">}</span></span>
<span id="cb27-18"></span>
<span id="cb27-19">  foreach_face<span class="op">(</span>y<span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-20">    <span class="cf">if</span> <span class="op">(</span>fm<span class="op">.</span>y<span class="op">[]</span> <span class="op">&gt;</span> <span class="fl">1e-20</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-21">      <span class="co">// x-gradient of T12 (shear stress)</span></span>
<span id="cb27-22">      <span class="dt">double</span> shearY <span class="op">=</span> <span class="op">(</span>T12<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> T12<span class="op">[</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span></span>
<span id="cb27-23">                       T12<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> T12<span class="op">[-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/</span><span class="fl">4.</span><span class="op">;</span></span>
<span id="cb27-24">      <span class="co">// y-gradient of T22 (normal stress)</span></span>
<span id="cb27-25">      <span class="dt">double</span> gradY_T22 <span class="op">=</span> cm<span class="op">[]*</span>T22<span class="op">[]</span> <span class="op">-</span> cm<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>T22<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb27-26"></span>
<span id="cb27-27">      av<span class="op">.</span>y<span class="op">[]</span> <span class="op">+=</span> <span class="op">(</span>shearY <span class="op">+</span> gradY_T22<span class="op">)*</span>alpha<span class="op">.</span>y<span class="op">[]/(</span>sq<span class="op">(</span>fm<span class="op">.</span>y<span class="op">[])*</span>Delta<span class="op">);</span></span>
<span id="cb27-28">    <span class="op">}</span></span>
<span id="cb27-29">  <span class="op">}</span></span>
<span id="cb27-30"></span>
<span id="cb27-31"><span class="pp">#elif dimension ==</span></span>
<span id="cb27-32">  <span class="co">// 3D implementation</span></span>
<span id="cb27-33">  foreach_face<span class="op">(</span>x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-34">    <span class="cf">if</span> <span class="op">(</span>fm<span class="op">.</span>x<span class="op">[]</span> <span class="op">&gt;</span> <span class="fl">1e-20</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-35">      <span class="co">// y-gradient of T12</span></span>
<span id="cb27-36">      <span class="dt">double</span> shearY <span class="op">=</span> <span class="op">(</span>T12<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> T12<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span></span>
<span id="cb27-37">                       T12<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> T12<span class="op">[-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">])/</span><span class="fl">4.</span><span class="op">;</span></span>
<span id="cb27-38">      <span class="co">// z-gradient of T13</span></span>
<span id="cb27-39">      <span class="dt">double</span> shearZ <span class="op">=</span> <span class="op">(</span>T13<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">+</span> T13<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span></span>
<span id="cb27-40">                       T13<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> T13<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/</span><span class="fl">4.</span><span class="op">;</span></span>
<span id="cb27-41">      <span class="co">// x-gradient of T11</span></span>
<span id="cb27-42">      <span class="dt">double</span> gradX_T11 <span class="op">=</span> cm<span class="op">[]*</span>T11<span class="op">[]</span> <span class="op">-</span> cm<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>T11<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb27-43"></span>
<span id="cb27-44">      av<span class="op">.</span>x<span class="op">[]</span> <span class="op">+=</span> <span class="op">(</span>shearY <span class="op">+</span> shearZ <span class="op">+</span> gradX_T11<span class="op">)*</span>alpha<span class="op">.</span>x<span class="op">[]/(</span>sq<span class="op">(</span>fm<span class="op">.</span>x<span class="op">[])*</span>Delta<span class="op">);</span></span>
<span id="cb27-45">    <span class="op">}</span></span>
<span id="cb27-46">  <span class="op">}</span></span>
<span id="cb27-47"></span>
<span id="cb27-48">  foreach_face<span class="op">(</span>y<span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-49">    <span class="cf">if</span> <span class="op">(</span>fm<span class="op">.</span>y<span class="op">[]</span> <span class="op">&gt;</span> <span class="fl">1e-20</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-50">      <span class="co">// x-gradient of T12</span></span>
<span id="cb27-51">      <span class="dt">double</span> shearX <span class="op">=</span> <span class="op">(</span>T12<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> T12<span class="op">[</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span></span>
<span id="cb27-52">                       T12<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> T12<span class="op">[-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">])/</span><span class="fl">4.</span><span class="op">;</span></span>
<span id="cb27-53">      <span class="co">// z-gradient of T23</span></span>
<span id="cb27-54">      <span class="dt">double</span> shearZ <span class="op">=</span> <span class="op">(</span>T23<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">+</span> T23<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span></span>
<span id="cb27-55">                       T23<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> T23<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/</span><span class="fl">4.</span><span class="op">;</span></span>
<span id="cb27-56">      <span class="co">// y-gradient of T22</span></span>
<span id="cb27-57">      <span class="dt">double</span> gradY_T22 <span class="op">=</span> cm<span class="op">[]*</span>T22<span class="op">[]</span> <span class="op">-</span> cm<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>T22<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb27-58"></span>
<span id="cb27-59">      av<span class="op">.</span>y<span class="op">[]</span> <span class="op">+=</span> <span class="op">(</span>shearX <span class="op">+</span> shearZ <span class="op">+</span> gradY_T22<span class="op">)*</span>alpha<span class="op">.</span>y<span class="op">[]/(</span>sq<span class="op">(</span>fm<span class="op">.</span>y<span class="op">[])*</span>Delta<span class="op">);</span></span>
<span id="cb27-60">    <span class="op">}</span></span>
<span id="cb27-61">  <span class="op">}</span></span>
<span id="cb27-62"></span>
<span id="cb27-63">  foreach_face<span class="op">(</span>z<span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-64">    <span class="cf">if</span> <span class="op">(</span>fm<span class="op">.</span>z<span class="op">[]</span> <span class="op">&gt;</span> <span class="fl">1e-20</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-65">      <span class="co">// x-gradient of T13</span></span>
<span id="cb27-66">      <span class="dt">double</span> shearX <span class="op">=</span> <span class="op">(</span>T13<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> T13<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span></span>
<span id="cb27-67">                       T13<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> T13<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/</span><span class="fl">4.</span><span class="op">;</span></span>
<span id="cb27-68">      <span class="co">// y-gradient of T23</span></span>
<span id="cb27-69">      <span class="dt">double</span> shearY <span class="op">=</span> <span class="op">(</span>T23<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> T23<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span></span>
<span id="cb27-70">                       T23<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> T23<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/</span><span class="fl">4.</span><span class="op">;</span></span>
<span id="cb27-71">      <span class="co">// z-gradient of T33</span></span>
<span id="cb27-72">      <span class="dt">double</span> gradZ_T33 <span class="op">=</span> cm<span class="op">[]*</span>T33<span class="op">[]</span> <span class="op">-</span> cm<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>T33<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb27-73"></span>
<span id="cb27-74">      av<span class="op">.</span>z<span class="op">[]</span> <span class="op">+=</span> <span class="op">(</span>shearX <span class="op">+</span> shearY <span class="op">+</span> gradZ_T33<span class="op">)*</span>alpha<span class="op">.</span>z<span class="op">[]/(</span>sq<span class="op">(</span>fm<span class="op">.</span>z<span class="op">[])*</span>Delta<span class="op">);</span></span>
<span id="cb27-75">    <span class="op">}</span></span>
<span id="cb27-76">  <span class="op">}</span></span>
<span id="cb27-77"><span class="pp">#endif</span></span>
<span id="cb27-78"><span class="op">}</span></span>
<span id="cb27-79"></span></code></pre></div></div>
            </div>
        </main>
<a id="" href="#"></a>
        <footer class="site-footer">
            <div class="footer-left">
              <a href="http://basilisk.fr/sandbox/vatsal/" target="_blank">
                <img src="../assets/logos/logoBasilisk_TransparentBackground.png" alt="Basilisk C" class="footer-logo">
              </a>
              <a href="https://pof.tnw.utwente.nl/" target="_blank">
                <img src="../assets/logos/LogoPof_transparent_white.png" alt="Physics of Fluids" class="footer-logo pof-logo">
              </a>
              <a href="https://www.utwente.nl/" target="_blank">
                <img src="../assets/logos/UT_Logo_2400_Sta_White_EN.png" alt="University of Twente" class="footer-logo">
              </a>
              <a href="https://www.vatsalsanjay.com/" target="_blank">
                <img src="../assets/logos/Logo_Vatsal_v3_OutLine.png" alt="Vatsal Sanjay" class="footer-logo">
              </a>
            </div>
            <div class="footer-center">
              <p class="copyright-text">
                &copy; Copyright<br>
                CoMPhy Lab 2025
              </p>
            </div>
            <div class="footer-right">
              <a href="https://scholar.google.com/citations?user=tHb_qZoAAAAJ&hl=en" target="_blank" aria-label="Google Scholar Profile">
                <i class="ai ai-google-scholar" style="font-size: 2.5em; color: white;"></i>
              </a>
              <a href="https://github.com/comphy-lab" target="_blank" aria-label="GitHub Organization">
                <i class="fa-brands fa-github" style="font-size: 2.5em; color: white;"></i>
              </a>
              <a href="https://www.youtube.com/@CoMPhyLab" target="_blank" aria-label="YouTube Channel">
                <i class="fa-brands fa-youtube" style="font-size: 2.5em; color: white;"></i>
              </a>
              <a href="https://x.com/VatsalSanjay" target="_blank" aria-label="X (Twitter) Profile">
                <i class="fa-brands fa-x-twitter" style="font-size: 2.5em; color: white;"></i>
              </a>
              <a href="https://bsky.app/profile/comphy-lab.org" target="_blank" aria-label="Bluesky Profile">
                <i class="fa-brands fa-bluesky" style="font-size: 2.5em; color: white;"></i>
              </a>
              <a href="https://github.com/comphy-lab/comphy-lab.github.io" class="edit-link" aria-label="Edit this page on GitHub">
                <i class="fa-brands fa-github"></i> Edit this page
              </a>
            </div>
          </footer>
    </div>  
<a id="" href="#"></a>
    <!-- Command Palette -->
    <div id="simple-command-palette" class="simple-command-palette" style="display: none;">
        <div class="simple-command-palette-backdrop"></div>
        <div class="simple-command-palette-modal">
            <input type="text" id="command-palette-input" placeholder="Type a command..." autocomplete="off">
            <div id="command-palette-results" class="command-palette-results"></div>
            <div class="command-palette-footer">
                <span class="command-palette-footer-item"><kbd>↑</kbd> <kbd>↓</kbd> to navigate</span>
                <span class="command-palette-footer-item"><kbd>enter</kbd> to select</span>
                <span class="command-palette-footer-item"><kbd>esc</kbd> to close</span>
            </div>
        </div>
    </div>
<a id="" href="#"></a>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // Add copy button to each code block container
    const codeBlocks = document.querySelectorAll('.code-block-container pre');
    codeBlocks.forEach(function(codeBlock, index) {
        // Create button element
        const button = document.createElement('button');
        button.className = 'copy-button';
        button.textContent = 'Copy';
        button.setAttribute('aria-label', 'Copy code to clipboard');
        button.setAttribute('data-copy-state', 'copy');
        
        // Get the code block container (parent of the pre)
        const container = codeBlock.parentNode;
        
        // Add the button to the container
        container.appendChild(button);
        
        // Set up click event
        button.addEventListener('click', async function() {
            const codeText = codeBlock.textContent;
            
            try {
                // Try to use the modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(codeText);
                    updateButtonState(button, 'success');
                } else {
                    // Fall back to the deprecated execCommand method
                    const textarea = document.createElement('textarea');
                    textarea.value = codeText;
                    textarea.style.position = 'fixed';  // Prevent scrolling to the bottom
                    document.body.appendChild(textarea);
                    textarea.select();
                    
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    if (successful) {
                        updateButtonState(button, 'success');
                    } else {
                        updateButtonState(button, 'error');
                    }
                }
            } catch (err) {
                console.error('Copy failed:', err);
                updateButtonState(button, 'error');
            }
        });
    });
    
    // Function to update button state
    function updateButtonState(button, state) {
        if (state === 'success') {
            button.textContent = 'Copied!';
            button.classList.add('copied');
        } else if (state === 'error') {
            button.textContent = 'Error!';
            button.classList.add('error');
        }
        
        // Reset button state after 2 seconds
        setTimeout(function() {
            button.textContent = 'Copy';
            button.classList.remove('copied', 'error');
        }, 2000);
    }
});
</script>
        </body>
</html>
